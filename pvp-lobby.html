<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çœŸäººå¯¹æˆ˜å¤§å… - å®å¯æ¢¦å¯¹æˆ˜å¹³å°</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #e53935 0%, #e35d5b 100%);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    h1 {
      text-align: center;
      color: #3d7dca;
      margin-bottom: 30px;
      font-size: 2.5rem;
    }

    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 10px;
    }

    .section h2 {
      color: #3d7dca;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      color: #666;
      font-weight: bold;
    }

    .input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    .input-group input:focus {
      outline: none;
      border-color: #3d7dca;
    }

    .btn {
      background: #3d7dca;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 15px 30px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 10px;
    }

    .btn:hover {
      background: #2a6cb8;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .room-status {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border: 2px solid #3d7dca;
    }

    .room-status h3 {
      color: #3d7dca;
      margin-bottom: 10px;
    }

    .room-id-display {
      font-size: 1.5rem;
      font-weight: bold;
      color: #3d7dca;
      text-align: center;
      padding: 10px;
      background: #e3f2fd;
      border-radius: 8px;
      margin: 10px 0;
    }

    .player-status {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      margin: 5px 0;
      background: #f9f9f9;
      border-radius: 5px;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-indicator.connected {
      background: #4caf50;
    }

    .status-indicator.disconnected {
      background: #f44336;
    }

    .status-indicator.ready {
      background: #2196f3;
    }

    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
    }

    .back-btn {
      background: #f5f5f5;
      color: #333;
      border: 2px solid #ddd;
      margin-top: 20px;
    }

    .back-btn:hover {
      background: #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ® çœŸäººå¯¹æˆ˜å¤§å…</h1>

    <!-- åˆ›å»ºæˆ¿é—´ -->
    <div class="section" id="create-room-section">
      <h2>åˆ›å»ºæˆ¿é—´</h2>
      <p style="margin-bottom: 15px; color: #666;">åˆ›å»ºä¸€ä¸ªæ–°æˆ¿é—´ï¼Œç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥</p>
      <button class="btn" onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
      <div id="room-id-display" style="display: none;">
        <div class="room-id-display" id="room-id-text"></div>
        <p style="text-align: center; color: #666; margin-top: 10px;">ç­‰å¾…ç©å®¶åŠ å…¥...</p>
      </div>
    </div>

    <!-- åŠ å…¥æˆ¿é—´ -->
    <div class="section" id="join-room-section">
      <h2>åŠ å…¥æˆ¿é—´</h2>
      <p style="margin-bottom: 15px; color: #666;">è¾“å…¥æˆ¿é—´IDåŠ å…¥å…¶ä»–ç©å®¶çš„æˆ¿é—´</p>
      <div class="input-group">
        <label for="room-id-input">æˆ¿é—´ID</label>
        <input type="text" id="room-id-input" placeholder="è¾“å…¥6ä½æˆ¿é—´ID" maxlength="6" style="text-transform: uppercase;">
      </div>
      <button class="btn" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
    </div>

    <!-- æˆ¿é—´çŠ¶æ€ -->
    <div class="section" id="room-status-section" style="display: none;">
      <h2>æˆ¿é—´çŠ¶æ€</h2>
      <div class="room-status">
        <h3>æˆ¿é—´ID: <span id="current-room-id"></span></h3>
        <div class="player-status">
          <span>
            <span class="status-indicator disconnected" id="p1-indicator"></span>
            <strong>ç©å®¶1</strong>
          </span>
          <span id="p1-status">æœªè¿æ¥</span>
        </div>
        <div class="player-status">
          <span>
            <span class="status-indicator disconnected" id="p2-indicator"></span>
            <strong>ç©å®¶2</strong>
          </span>
          <span id="p2-status">æœªè¿æ¥</span>
        </div>
        <button class="btn" id="start-battle-btn" onclick="startBattle()" disabled style="margin-top: 20px;">å¼€å§‹å¯¹æˆ˜</button>
      </div>
    </div>

    <!-- é”™è¯¯æ¶ˆæ¯ -->
    <div id="error-message" class="error-message" style="display: none;"></div>

    <!-- è¿”å›æŒ‰é’® -->
    <button class="btn back-btn" onclick="window.location.href='pokemmo.html'">è¿”å›ä¸»é¡µ</button>
  </div>

  <script type="module">
    import './packages/battle-engine/src/legacy-shim.js';
    
    let engine = null;
    let currentRoomId = null;
    let myTeam = null;
    let mySide = null; // ä¿å­˜ç©å®¶èº«ä»½ï¼ˆp1æˆ–p2ï¼‰

    // åŠ è½½é˜Ÿä¼
    function loadTeam() {
      try {
        // ä½¿ç”¨ä¸ä¸»é¡µä¸€è‡´çš„keyåç§°
        const teamStr = localStorage.getItem('pokemonTeam');
        if (teamStr) {
          myTeam = JSON.parse(teamStr);
          // è¿‡æ»¤æ‰ç©ºå€¼
          if (Array.isArray(myTeam)) {
            myTeam = myTeam.filter(p => p !== null && p !== undefined);
          }
          console.log('[PVP Lobby] é˜Ÿä¼åŠ è½½æˆåŠŸï¼Œæ•°é‡:', myTeam ? myTeam.length : 0);
          
          // æ£€æŸ¥é˜Ÿä¼æ˜¯å¦å®Œæ•´ï¼ˆè‡³å°‘1åªå®å¯æ¢¦ï¼‰
          if (!myTeam || myTeam.length === 0) {
            console.warn('[PVP Lobby] é˜Ÿä¼ä¸ºç©º');
            showError('è¯·å…ˆåœ¨ä¸»é¡µç»„å»ºé˜Ÿä¼');
            myTeam = null;
          } else {
            console.log('[PVP Lobby] âœ… é˜Ÿä¼åŠ è½½æˆåŠŸï¼ŒåŒ…å«', myTeam.length, 'åªå®å¯æ¢¦');
          }
        } else {
          console.warn('[PVP Lobby] æœªæ‰¾åˆ°é˜Ÿä¼ï¼ˆlocalStorageä¸­æ²¡æœ‰pokemonTeamï¼‰');
          showError('è¯·å…ˆåœ¨ä¸»é¡µç»„å»ºé˜Ÿä¼');
          myTeam = null;
        }
      } catch (e) {
        console.error('[PVP Lobby] åŠ è½½é˜Ÿä¼å¤±è´¥:', e);
        showError('åŠ è½½é˜Ÿä¼å¤±è´¥: ' + e.message);
        myTeam = null;
      }
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    // åˆ›å»ºæˆ¿é—´
    async function createRoom() {
      // é‡æ–°åŠ è½½é˜Ÿä¼ï¼ˆç¡®ä¿è·å–æœ€æ–°æ•°æ®ï¼‰
      loadTeam();
      
      if (!myTeam || myTeam.length === 0) {
        showError('è¯·å…ˆåœ¨ä¸»é¡µç»„å»ºå®Œæ•´çš„é˜Ÿä¼ï¼ˆè‡³å°‘1åªå®å¯æ¢¦ï¼‰');
        return;
      }

      try {
        engine = new BattleEngine();
        await engine.connect();

        // ç›‘å¬æ¶ˆæ¯ï¼ˆä½¿ç”¨onMessageæ–¹æ³•ï¼‰
        engine.onMessage(handleMessage);

        // å‘é€åˆ›å»ºæˆ¿é—´æ¶ˆæ¯
        engine.send({
          type: 'create-room',
          payload: {}
        });

        console.log('[PVP Lobby] å‘é€åˆ›å»ºæˆ¿é—´è¯·æ±‚');
      } catch (e) {
        console.error('[PVP Lobby] åˆ›å»ºæˆ¿é—´å¤±è´¥:', e);
        showError('è¿æ¥æœåŠ¡å™¨å¤±è´¥: ' + e.message);
      }
    }

    // åŠ å…¥æˆ¿é—´
    async function joinRoom() {
      const roomId = document.getElementById('room-id-input').value.trim().toUpperCase();
      if (!roomId || roomId.length !== 6) {
        showError('è¯·è¾“å…¥æœ‰æ•ˆçš„6ä½æˆ¿é—´ID');
        return;
      }

      // é‡æ–°åŠ è½½é˜Ÿä¼ï¼ˆç¡®ä¿è·å–æœ€æ–°æ•°æ®ï¼‰
      loadTeam();
      
      if (!myTeam || myTeam.length === 0) {
        showError('è¯·å…ˆåœ¨ä¸»é¡µç»„å»ºå®Œæ•´çš„é˜Ÿä¼ï¼ˆè‡³å°‘1åªå®å¯æ¢¦ï¼‰');
        return;
      }

      try {
        engine = new BattleEngine();
        await engine.connect();

        // ç›‘å¬æ¶ˆæ¯ï¼ˆä½¿ç”¨onMessageæ–¹æ³•ï¼‰
        engine.onMessage(handleMessage);

        // å‘é€åŠ å…¥æˆ¿é—´æ¶ˆæ¯
        engine.send({
          type: 'join-room',
          payload: { roomId }
        });

        console.log('[PVP Lobby] å‘é€åŠ å…¥æˆ¿é—´è¯·æ±‚:', roomId);
      } catch (e) {
        console.error('[PVP Lobby] åŠ å…¥æˆ¿é—´å¤±è´¥:', e);
        showError('è¿æ¥æœåŠ¡å™¨å¤±è´¥: ' + e.message);
      }
    }

    // å¤„ç†æ¶ˆæ¯
    function handleMessage(data) {
      try {
        // BattleEngineä¼ é€’çš„æ˜¯å­—ç¬¦ä¸²ï¼Œå¯èƒ½æ˜¯JSONæ ¼å¼æˆ–åè®®æ ¼å¼
        let message;
        
        // å°è¯•è§£æä¸ºJSONï¼ˆå¦‚æœæ˜¯JSONæ ¼å¼ï¼‰
        if (typeof data === 'string' && (data.trim().startsWith('{') || data.trim().startsWith('['))) {
          try {
            message = JSON.parse(data);
            console.log('[PVP Lobby] æ”¶åˆ°JSONæ¶ˆæ¯:', message);
          } catch (e) {
            // ä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯åè®®æ ¼å¼
            console.log('[PVP Lobby] æ”¶åˆ°åè®®æ¶ˆæ¯ï¼ˆéJSONï¼‰:', data.substring(0, 100));
            // åè®®æ¶ˆæ¯ä¸éœ€è¦åœ¨è¿™é‡Œå¤„ç†ï¼Œç›´æ¥è¿”å›
            return;
          }
        } else {
          // ä¸æ˜¯å­—ç¬¦ä¸²æˆ–ä¸æ˜¯JSONæ ¼å¼
          console.log('[PVP Lobby] æ”¶åˆ°éJSONæ¶ˆæ¯:', typeof data, data);
          return;
        }
        
        if (!message || !message.type) {
          console.warn('[PVP Lobby] æ¶ˆæ¯æ ¼å¼ä¸æ­£ç¡®:', message);
          return;
        }

        switch (message.type) {
          case 'room-created':
            currentRoomId = message.payload.roomId;
            mySide = message.payload.side || 'p1'; // åˆ›å»ºè€…æ˜¯p1
            // ä¿å­˜åˆ°localStorageï¼Œä»¥ä¾¿battle.htmlä½¿ç”¨
            localStorage.setItem('pvpRoomId', currentRoomId);
            localStorage.setItem('pvpSide', mySide);
            document.getElementById('room-id-text').textContent = currentRoomId;
            document.getElementById('room-id-display').style.display = 'block';
            // room-created æ¶ˆæ¯ä¸åŒ…å«å®Œæ•´çš„æˆ¿é—´çŠ¶æ€ï¼Œç­‰å¾… room-update æ¶ˆæ¯
            // updateRoomStatus(message.payload); // æ³¨é‡Šæ‰ï¼Œç­‰å¾… room-update
            break;

          case 'room-joined':
            currentRoomId = message.payload.roomId;
            mySide = message.payload.side || 'p2'; // åŠ å…¥è€…æ˜¯p2
            // ä¿å­˜åˆ°localStorageï¼Œä»¥ä¾¿battle.htmlä½¿ç”¨
            localStorage.setItem('pvpRoomId', currentRoomId);
            localStorage.setItem('pvpSide', mySide);
            // room-joined æ¶ˆæ¯ä¸åŒ…å«å®Œæ•´çš„æˆ¿é—´çŠ¶æ€ï¼Œç­‰å¾… room-update æ¶ˆæ¯
            // updateRoomStatus(message.payload); // æ³¨é‡Šæ‰ï¼Œç­‰å¾… room-update
            break;

          case 'room-update':
            currentRoomId = message.payload.roomId;
            // ä»æˆ¿é—´çŠ¶æ€ä¸­ç¡®å®šè‡ªå·±çš„side
            // å¦‚æœp1å·²è¿æ¥ä¸”æ˜¯æˆ‘ï¼Œæˆ‘æ˜¯p1ï¼›å¦‚æœp2å·²è¿æ¥ä¸”æ˜¯æˆ‘ï¼Œæˆ‘æ˜¯p2
            if (message.payload.players) {
              // é€šè¿‡æ£€æŸ¥å“ªä¸ªç©å®¶æ˜¯æˆ‘æ¥ç¡®å®šside
              // ç”±äºæˆ‘ä»¬æ— æ³•ç›´æ¥åˆ¤æ–­ï¼Œæˆ‘ä»¬ä¼šåœ¨åŠ å…¥æˆ¿é—´æ—¶ä»æœåŠ¡å™¨è·å–
              // æš‚æ—¶ä¸è®¾ç½®ï¼Œç­‰æœåŠ¡å™¨è¿”å›
            }
            // å¦‚æœçŠ¶æ€ä» waiting å˜ä¸º readyï¼Œä¸”æˆ‘è¿˜æ²¡å‘é€è¿‡ startï¼Œé‡ç½®æ ‡å¿—ï¼ˆå¯èƒ½æ˜¯ä¹‹å‰æ‰‹åŠ¨ç‚¹å‡»è¢«é˜»æ­¢äº†ï¼‰
            if (message.payload.status === 'ready' && !hasSentStart) {
              console.log('[PVP Lobby] çŠ¶æ€å˜ä¸ºreadyï¼Œä¸”æˆ‘è¿˜æ²¡å‘é€è¿‡startï¼Œç¡®ä¿å¯ä»¥å‘é€');
              // ä¸éœ€è¦é‡ç½®ï¼Œå› ä¸º hasSentStart å·²ç»æ˜¯ false
            }
            updateRoomStatus(message.payload);
            break;

          case 'battle-started':
            // é‡ç½®å‘é€æ ‡å¿—ï¼ˆå¯¹æˆ˜å·²å¼€å§‹ï¼Œå¯ä»¥é‡ç½®ï¼‰
            console.log('[PVP Lobby] æ”¶åˆ° battle-started æ¶ˆæ¯ï¼Œé‡ç½®å‘é€æ ‡å¿—');
            isSendingStart = false;
            hasSentStart = false;
            
            // ç¡®ä¿ä¿å­˜äº†æˆ¿é—´IDå’Œsideï¼ˆç”¨äºå…¼å®¹æ€§ï¼Œä½†ä¸»è¦ä½¿ç”¨URLå‚æ•°ï¼‰
            if (currentRoomId) {
              localStorage.setItem('pvpRoomId', currentRoomId);
            }
            if (mySide) {
              localStorage.setItem('pvpSide', mySide);
            }
            
            // å…³é”®ä¿®å¤ï¼šé€šè¿‡URLå‚æ•°ä¼ é€’sideï¼Œé¿å…localStorageå†²çª
            const side = mySide || localStorage.getItem('pvpSide') || 'p1';
            console.log('[PVP Lobby] è·³è½¬åˆ°å¯¹æˆ˜é¡µé¢ï¼Œside:', side);
            
            // åœ¨è·³è½¬å‰å…³é—­WebSocketè¿æ¥ï¼Œç¡®ä¿æ—§è¿æ¥è¢«æ¸…ç†
            if (engine && engine.ws) {
              console.log('[PVP Lobby] è·³è½¬å‰å…³é—­WebSocketè¿æ¥');
              const ws = engine.ws;
              const roomId = currentRoomId;
              
              // ç›‘å¬å…³é—­äº‹ä»¶ï¼Œç¡®ä¿è¿æ¥å…³é—­åå†è·³è½¬
              const closeHandler = () => {
                console.log('[PVP Lobby] WebSocketè¿æ¥å·²å…³é—­ï¼Œå‡†å¤‡è·³è½¬');
                setTimeout(() => {
                  // å…³é”®ä¿®å¤ï¼šé€šè¿‡URLå‚æ•°ä¼ é€’sideï¼Œé¿å…localStorageå†²çª
                  window.location.href = `battle.html?mode=pvp&roomId=${roomId}&side=${side}`;
                }, 50); // å†ç­‰å¾…50msç¡®ä¿æœåŠ¡å™¨ç«¯å·²å¤„ç†å…³é—­äº‹ä»¶
              };
              
              // å¦‚æœè¿æ¥å·²ç»å…³é—­æˆ–æ­£åœ¨å…³é—­ï¼Œç›´æ¥è·³è½¬
              if (ws.readyState === WebSocket.CLOSED || ws.readyState === WebSocket.CLOSING) {
                console.log('[PVP Lobby] WebSocketè¿æ¥çŠ¶æ€:', ws.readyState, 'ï¼Œç›´æ¥è·³è½¬');
                setTimeout(() => {
                  // å…³é”®ä¿®å¤ï¼šé€šè¿‡URLå‚æ•°ä¼ é€’sideï¼Œé¿å…localStorageå†²çª
                  window.location.href = `battle.html?mode=pvp&roomId=${roomId}&side=${side}`;
                }, 200);
              } else {
                // è¿æ¥è¿˜åœ¨OPENçŠ¶æ€ï¼Œç›‘å¬å…³é—­äº‹ä»¶
                ws.addEventListener('close', closeHandler, { once: true });
                try {
                  ws.close();
                } catch (e) {
                  console.warn('[PVP Lobby] å…³é—­è¿æ¥æ—¶å‡ºé”™:', e);
                  // å¦‚æœå…³é—­å¤±è´¥ï¼Œå»¶è¿Ÿåç›´æ¥è·³è½¬
                  setTimeout(() => {
                    // å…³é”®ä¿®å¤ï¼šé€šè¿‡URLå‚æ•°ä¼ é€’sideï¼Œé¿å…localStorageå†²çª
                    window.location.href = `battle.html?mode=pvp&roomId=${roomId}&side=${side}`;
                  }, 500);
                }
                
                // è®¾ç½®è¶…æ—¶ï¼Œå¦‚æœ5ç§’å†…è¿æ¥è¿˜æ²¡å…³é—­ï¼Œå¼ºåˆ¶è·³è½¬
                setTimeout(() => {
                  if (ws.readyState !== WebSocket.CLOSED) {
                    console.warn('[PVP Lobby] WebSocketè¿æ¥å…³é—­è¶…æ—¶ï¼Œå¼ºåˆ¶è·³è½¬');
                    ws.removeEventListener('close', closeHandler);
                    // å…³é”®ä¿®å¤ï¼šé€šè¿‡URLå‚æ•°ä¼ é€’sideï¼Œé¿å…localStorageå†²çª
                    window.location.href = `battle.html?mode=pvp&roomId=${roomId}&side=${side}`;
                  }
                }, 5000);
              }
            } else {
              // æ²¡æœ‰engineæˆ–wsï¼Œç›´æ¥è·³è½¬
              // å…³é”®ä¿®å¤ï¼šé€šè¿‡URLå‚æ•°ä¼ é€’sideï¼Œé¿å…localStorageå†²çª
              const fallbackSide = mySide || localStorage.getItem('pvpSide') || 'p1';
              window.location.href = `battle.html?mode=pvp&roomId=${currentRoomId}&side=${fallbackSide}`;
            }
            break;

          case 'error':
            showError(message.payload.message);
            break;

          case 'opponent-disconnected':
            showError('å¯¹æ‰‹å·²æ–­å¼€è¿æ¥');
            updateRoomStatus({ status: 'waiting', players: { p1: { connected: false }, p2: { connected: false } } });
            break;

          case 'room-closed':
            showError('æˆ¿é—´å·²å…³é—­');
            resetUI();
            break;
        }
      } catch (e) {
        console.error('[PVP Lobby] è§£ææ¶ˆæ¯å¤±è´¥:', e);
      }
    }

    // æ›´æ–°æˆ¿é—´çŠ¶æ€
    function updateRoomStatus(status) {
      document.getElementById('room-status-section').style.display = 'block';
      document.getElementById('current-room-id').textContent = status.roomId || currentRoomId;

      // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœ status.players ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å€¼
      const players = status.players || {};
      const p1Info = players.p1 || { connected: false, teamReady: false };
      const p2Info = players.p2 || { connected: false, teamReady: false };

      // æ›´æ–°ç©å®¶1çŠ¶æ€
      const p1Connected = p1Info.connected || false;
      const p1Ready = p1Info.teamReady || false;
      document.getElementById('p1-indicator').className = `status-indicator ${p1Connected ? (p1Ready ? 'ready' : 'connected') : 'disconnected'}`;
      document.getElementById('p1-status').textContent = p1Connected ? (p1Ready ? 'å·²å‡†å¤‡' : 'å·²è¿æ¥') : 'æœªè¿æ¥';

      // æ›´æ–°ç©å®¶2çŠ¶æ€
      const p2Connected = p2Info.connected || false;
      const p2Ready = p2Info.teamReady || false;
      document.getElementById('p2-indicator').className = `status-indicator ${p2Connected ? (p2Ready ? 'ready' : 'connected') : 'disconnected'}`;
      document.getElementById('p2-status').textContent = p2Connected ? (p2Ready ? 'å·²å‡†å¤‡' : 'å·²è¿æ¥') : 'æœªè¿æ¥';

      // å¦‚æœä¸¤ä¸ªç©å®¶éƒ½å‡†å¤‡å¥½äº†ï¼Œè‡ªåŠ¨å‘é€startæ¶ˆæ¯ï¼ˆä¸¤ä¸ªç©å®¶éƒ½éœ€è¦å‘é€ï¼‰
      // æ³¨æ„ï¼šåªæœ‰åœ¨çŠ¶æ€æ˜¯ 'ready' æ—¶æ‰è‡ªåŠ¨å‘é€ï¼ˆè¡¨ç¤ºç¬¬ä¸€ä¸ªç©å®¶å·²ç»å‘é€äº†startï¼‰
      // å¦‚æœçŠ¶æ€æ˜¯ 'waiting'ï¼Œéœ€è¦æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®
      console.log(`[PVP Lobby] æˆ¿é—´çŠ¶æ€æ£€æŸ¥: p1Ready=${p1Ready}, p2Ready=${p2Ready}, status=${status.status}`);
      console.log(`[PVP Lobby] å‘é€çŠ¶æ€æ£€æŸ¥: isSendingStart=${isSendingStart}, hasSentStart=${hasSentStart}`);
      console.log(`[PVP Lobby] æˆ‘çš„side: ${mySide}`);
      
      if (p1Ready && p2Ready && status.status === 'ready') {
        // ä¸¤ä¸ªç©å®¶éƒ½å‡†å¤‡å¥½äº†ï¼Œä¸”çŠ¶æ€æ˜¯readyï¼ˆç¬¬ä¸€ä¸ªç©å®¶å·²å‘é€startï¼‰ï¼Œè‡ªåŠ¨å‘é€startæ¶ˆæ¯
        // ä½†åªæœ‰åœ¨è‡ªå·±è¿˜æ²¡å‘é€è¿‡startçš„æƒ…å†µä¸‹æ‰å‘é€
        // é‡è¦ï¼šå¦‚æœçŠ¶æ€æ˜¯ readyï¼Œè¯´æ˜ç¬¬ä¸€ä¸ªç©å®¶å·²ç»å‘é€äº†ï¼Œç¬¬äºŒä¸ªç©å®¶å¿…é¡»å‘é€æ‰èƒ½å¼€å§‹å¯¹æˆ˜
        if (!hasSentStart && !isSendingStart) {
          console.log('[PVP Lobby] æ£€æµ‹åˆ°ä¸¤ä¸ªç©å®¶éƒ½å‡†å¤‡å¥½ä¸”çŠ¶æ€æ˜¯readyï¼Œè‡ªåŠ¨å‘é€startæ¶ˆæ¯');
          startBattle();
        } else {
          console.log('[PVP Lobby] å·²ç»å‘é€è¿‡startæˆ–æ­£åœ¨å‘é€ï¼Œè·³è¿‡è‡ªåŠ¨å‘é€');
          console.log(`[PVP Lobby] åŸå› : hasSentStart=${hasSentStart}, isSendingStart=${isSendingStart}`);
          // å¦‚æœçŠ¶æ€æ˜¯ ready ä½† hasSentStart=trueï¼Œå¯èƒ½æ˜¯ä¹‹å‰å‘é€å¤±è´¥æˆ–è¢«é˜»æ­¢äº†
          // å¼ºåˆ¶é‡ç½®æ ‡å¿—ï¼Œå…è®¸é‡æ–°å‘é€ï¼ˆä½†åªé‡ç½®ä¸€æ¬¡ï¼Œé¿å…æ— é™å¾ªç¯ï¼‰
          if (hasSentStart && status.status === 'ready') {
            console.warn('[PVP Lobby] âš ï¸ çŠ¶æ€æ˜¯readyä½†hasSentStart=trueï¼Œå¯èƒ½æ˜¯ä¹‹å‰å‘é€å¤±è´¥ï¼Œå¼ºåˆ¶é‡ç½®æ ‡å¿—');
            hasSentStart = false;
            isSendingStart = false;
            // å»¶è¿Ÿä¸€ä¸‹å†å‘é€ï¼Œé¿å…ç«‹å³è§¦å‘
            setTimeout(() => {
              if (!hasSentStart && !isSendingStart) {
                console.log('[PVP Lobby] é‡ç½®åé‡æ–°å°è¯•å‘é€startæ¶ˆæ¯');
                startBattle();
              }
            }, 100);
          }
        }
      } else if (p1Ready && p2Ready && status.status === 'waiting') {
        // ä¸¤ä¸ªç©å®¶éƒ½å‡†å¤‡å¥½äº†ï¼Œä½†çŠ¶æ€è¿˜æ˜¯waitingï¼ˆç¬¬ä¸€ä¸ªç©å®¶è¿˜æ²¡å‘é€startï¼‰ï¼Œæ˜¾ç¤ºæŒ‰é’®
        console.log('[PVP Lobby] ä¸¤ä¸ªç©å®¶éƒ½å‡†å¤‡å¥½ï¼Œä½†çŠ¶æ€æ˜¯waitingï¼Œæ˜¾ç¤ºå‡†å¤‡æŒ‰é’®');
        const startBtn = document.getElementById('start-battle-btn');
        startBtn.disabled = false;
        startBtn.textContent = 'å‡†å¤‡å¯¹æˆ˜';
      } else {
        // æ˜¾ç¤ºå¼€å§‹æŒ‰é’®ï¼ˆå¦‚æœä¸¤ä¸ªç©å®¶éƒ½è¿æ¥ä½†æœªå‡†å¤‡ï¼‰
        const startBtn = document.getElementById('start-battle-btn');
        if (p1Connected && p2Connected) {
          startBtn.disabled = false;
          startBtn.textContent = 'å‡†å¤‡å¯¹æˆ˜';
        } else {
          startBtn.disabled = true;
          startBtn.textContent = 'ç­‰å¾…ç©å®¶';
        }
      }
    }

    // é˜²æ­¢é‡å¤å‘é€ start æ¶ˆæ¯çš„æ ‡å¿—
    let isSendingStart = false;
    let hasSentStart = false;

    // å¼€å§‹å¯¹æˆ˜
    function startBattle() {
      // é˜²æ­¢é‡å¤å‘é€
      if (hasSentStart) {
        console.log('[PVP Lobby] âš ï¸ å·²ç»å‘é€è¿‡startæ¶ˆæ¯ï¼Œå¿½ç•¥é‡å¤è¯·æ±‚');
        return;
      }
      
      if (isSendingStart) {
        console.log('[PVP Lobby] âš ï¸ æ­£åœ¨å‘é€startæ¶ˆæ¯ï¼Œå¿½ç•¥é‡å¤è¯·æ±‚');
        return;
      }
      
      // æ£€æŸ¥engineæ˜¯å¦å­˜åœ¨
      if (!engine) {
        console.error('[PVP Lobby] engineä¸å­˜åœ¨ï¼Œæ— æ³•å‘é€startæ¶ˆæ¯');
        showError('è¿æ¥æœªå»ºç«‹ï¼Œè¯·é‡æ–°åˆ›å»ºæˆ–åŠ å…¥æˆ¿é—´');
        return;
      }
      
      // æ£€æŸ¥engineæ˜¯å¦å·²è¿æ¥
      if (!engine.isConnected) {
        console.error('[PVP Lobby] engineæœªè¿æ¥');
        showError('è¿æ¥å·²æ–­å¼€ï¼Œè¯·é‡æ–°åˆ›å»ºæˆ–åŠ å…¥æˆ¿é—´');
        return;
      }
      
      // é‡æ–°åŠ è½½é˜Ÿä¼ï¼ˆç¡®ä¿è·å–æœ€æ–°æ•°æ®ï¼‰
      loadTeam();
      
      if (!currentRoomId) {
        showError('ç¼ºå°‘æˆ¿é—´ID');
        return;
      }
      
      if (!myTeam || myTeam.length === 0) {
        showError('è¯·å…ˆåœ¨ä¸»é¡µç»„å»ºå®Œæ•´çš„é˜Ÿä¼');
        return;
      }
      
      // è®¾ç½®æ ‡å¿—
      isSendingStart = true;
      
      console.log('[PVP Lobby] å‡†å¤‡å‘é€å¼€å§‹å¯¹æˆ˜è¯·æ±‚');
      console.log('[PVP Lobby] æˆ¿é—´ID:', currentRoomId);
      console.log('[PVP Lobby] é˜Ÿä¼æ•°é‡:', myTeam.length);
      console.log('[PVP Lobby] engineçŠ¶æ€:', engine.isConnected);

      // å‘é€å¼€å§‹å¯¹æˆ˜æ¶ˆæ¯
      // é‡è¦ï¼šåŒ…å«sideä¿¡æ¯ï¼Œç”¨äºé‡è¿æ—¶è¯†åˆ«ç©å®¶èº«ä»½
      // ä¼˜å…ˆä½¿ç”¨ mySideï¼ˆä»æœåŠ¡å™¨æ¶ˆæ¯ä¸­è·å–ï¼‰ï¼Œè¿™æ˜¯æœ€å¯é çš„
      const side = mySide || localStorage.getItem('pvpSide') || 'p1';
      console.log('[PVP Lobby] å‘é€startæ¶ˆæ¯ï¼ŒåŒ…å«side:', side);
      console.log('[PVP Lobby] sideæ¥æº: mySide=' + (mySide || 'æ— ') + ', localStorage=' + (localStorage.getItem('pvpSide') || 'æ— '));
      const success = engine.startBattle({
        mode: 'pvp',
        formatid: 'gen9ou',
        team: myTeam,
        roomId: currentRoomId,
        side: side  // é‡è¦ï¼šåŒ…å«sideä¿¡æ¯
      });

      if (success) {
        console.log('[PVP Lobby] âœ… å¼€å§‹å¯¹æˆ˜è¯·æ±‚å·²å‘é€');
        hasSentStart = true;
        // ç«‹å³é‡ç½® isSendingStartï¼ˆå‘é€æ˜¯åŒæ­¥çš„ï¼Œä¸éœ€è¦ç­‰å¾…ï¼‰
        isSendingStart = false;
        console.log('[PVP Lobby] isSendingStart å·²é‡ç½®');
      } else {
        console.error('[PVP Lobby] âŒ å‘é€å¼€å§‹å¯¹æˆ˜è¯·æ±‚å¤±è´¥');
        showError('å‘é€è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥');
        isSendingStart = false;
      }
    }

    // é‡ç½®UI
    function resetUI() {
      currentRoomId = null;
      document.getElementById('room-status-section').style.display = 'none';
      document.getElementById('room-id-display').style.display = 'none';
    }

    // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿HTMLçš„onclickå¯ä»¥è®¿é—®
    window.createRoom = createRoom;
    window.joinRoom = joinRoom;
    window.startBattle = startBattle;
    
    // é¡µé¢åŠ è½½æ—¶åŠ è½½é˜Ÿä¼
    window.addEventListener('load', () => {
      loadTeam();
      // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œåªæ˜¯é™é»˜åŠ è½½
      // å¦‚æœé˜Ÿä¼ä¸å­˜åœ¨ï¼Œä¼šåœ¨ç”¨æˆ·å°è¯•åˆ›å»º/åŠ å…¥æˆ¿é—´æ—¶æç¤º
    });
    
    // é¡µé¢å¯è§æ€§æ”¹å˜æ—¶é‡æ–°åŠ è½½é˜Ÿä¼ï¼ˆç”¨æˆ·å¯èƒ½ä»å…¶ä»–æ ‡ç­¾é¡µä¿®æ”¹äº†é˜Ÿä¼ï¼‰
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        console.log('[PVP Lobby] é¡µé¢é‡æ–°å¯è§ï¼Œé‡æ–°åŠ è½½é˜Ÿä¼');
        loadTeam();
      }
    });
  </script>
</body>
</html>


# 部署分析：压缩包分发指南

> 本文档分析将 `pokemmo myself` 文件夹压缩发给别人后，对方需要哪些步骤才能直接使用。

---

## 📋 快速结论

**❌ 不能直接使用**，需要以下步骤：

1. ✅ 安装 Node.js（>=16，推荐 18）
2. ✅ 安装 npm 依赖（2个目录）
3. ⚠️ 确保 Pokemon Showdown 库存在
4. ⚠️ 配置环境变量（可选）
5. ⚠️ 安装 Python 依赖（仅 RAG 功能需要）

**预计安装时间**：5-10 分钟（取决于网络速度）

---

## 🔍 详细分析

### 1. 必需依赖

#### 1.1 Node.js 环境

**要求**：
- Node.js >= 16.0.0（推荐 18.20.2）
- npm（随 Node.js 安装）

**检查方法**：
```bash
node -v  # 应显示 v18.x.x 或更高
npm -v   # 应显示 10.x.x 或更高
```

**如果未安装**：
- 下载：https://nodejs.org/
- 安装后重启终端

---

#### 1.2 npm 依赖安装

项目需要**两个地方**安装依赖：

**① 根目录依赖**：
```bash
cd "pokemmo myself"
npm install
```

**② 后端服务依赖**：
```bash
cd "pokemmo myself/poke-proxy-server"
npm install
```

**依赖大小**：
- 根目录：约 50-100 MB
- 后端目录：约 20-50 MB
- 总计：约 70-150 MB（首次下载）

**安装时间**：3-8 分钟（取决于网络）

---

### 2. 外部依赖检查

#### 2.1 Pokemon Showdown 库

**问题**：代码中引用：
```javascript
const PS = require(path.resolve(__dirname, '../../../pokemon-showdown/dist/sim'));
```

**路径解析**：
- 从 `poke-proxy-server/core/BattleManager.js` 向上查找
- 期望路径：`pokemmo myself/../pokemon-showdown/dist/sim`
- 即：`pokemmo/pokemon-showdown/dist/sim`

**检查方法**：
```bash
# 在 pokemmo myself 目录的上一级
ls pokemon-showdown/dist/sim
```

**如果不存在**：
- 需要从项目根目录的 `pokemon-showdown` 或 `external/pokemon-showdown` 复制
- 或者需要单独安装 Pokemon Showdown

**解决方案**：
1. **方案一**：压缩时包含 `pokemon-showdown` 目录（如果存在）
2. **方案二**：提供安装脚本，自动下载 Pokemon Showdown
3. **方案三**：修改代码，使用 npm 包而不是本地路径

---

#### 2.2 数据文件

**已包含在压缩包中**：
- ✅ `data/` - 中文数据、pokedex 等
- ✅ `cache/sprites/` - 精灵贴图（830 个文件）
- ✅ `RAG/data/` - RAG 知识库数据（343 个文件）

**这些文件较大**：
- `cache/sprites/` 可能占用 50-200 MB
- 建议压缩时包含，但可以标记为可选

---

### 3. 可选依赖

#### 3.1 Python 环境（仅 RAG 功能需要）

**如果只需要基本对战功能**：❌ 不需要

**如果需要 RAG 增强 AI（难度 5）**：✅ 需要

**要求**：
- Python 3.8+
- 安装依赖：
  ```bash
  cd "pokemmo myself/RAG"
  pip install -r requirements.txt
  ```

**依赖大小**：约 500 MB - 2 GB（包含 PyTorch）

---

#### 3.2 环境变量配置

**文件**：`poke-proxy-server/env.example`

**是否需要**：可选（有默认值）

**如果配置**：
```bash
cd "pokemmo myself/poke-proxy-server"
cp env.example .env
# 编辑 .env 文件（可选）
```

**默认值**：
- `BATTLE_PORT=3071`
- `DEBUG_AI=0`
- 其他路径使用相对路径

---

### 4. 启动步骤

#### 4.1 完整启动流程

```bash
# 1. 解压压缩包
unzip pokemmo-myself.zip
cd "pokemmo myself"

# 2. 安装根目录依赖
npm install

# 3. 安装后端依赖
cd poke-proxy-server
npm install
cd ..

# 4. （可选）检查 Pokemon Showdown
# 确保 ../pokemon-showdown/dist/sim 存在

# 5. 启动后端服务器
cd poke-proxy-server
node battle-server.js
# 保持运行，打开新终端

# 6. 启动前端服务器
cd "pokemmo myself"
node simple-http-server.js 8080

# 7. 打开浏览器
# http://localhost:8080/pokemmo.html
```

---

### 5. 压缩包建议

#### 5.1 应该包含的文件

✅ **必须包含**：
- 所有源代码（`.js`, `.html`, `.json`）
- `data/` 目录（中文数据）
- `docs/` 目录（文档）
- `package.json` 和 `package-lock.json`（两个目录）
- `cache/sprites/`（精灵贴图）
- `RAG/` 目录（包括数据，但不包括 `__pycache__`）

❌ **不应该包含**：
- `node_modules/`（太大，让用户自己安装）
- `poke-proxy-server/node_modules/`
- `RAG/__pycache__/`
- `.env` 文件（包含敏感信息）
- `logs/` 目录（运行时生成）
- `coverage/` 目录（测试覆盖率报告）

⚠️ **可选包含**：
- `pokemon-showdown/` 目录（如果存在且路径正确）
- `pokemon-showdown-client-master/`（参考代码，非必需）

---

#### 5.2 压缩包大小估算

| 内容 | 大小 | 是否包含 |
|------|------|----------|
| 源代码 | 5-10 MB | ✅ 必须 |
| data/ | 10-20 MB | ✅ 必须 |
| cache/sprites/ | 50-200 MB | ✅ 建议 |
| RAG/data/ | 10-50 MB | ✅ 建议 |
| docs/ | 1-2 MB | ✅ 必须 |
| node_modules/ | 150-300 MB | ❌ 不包含 |
| **总计（不含 node_modules）** | **76-282 MB** | - |

---

### 6. 创建部署脚本

建议创建一个 `安装说明.md` 或 `快速开始.bat`（Windows）：

#### Windows 批处理脚本示例

```batch
@echo off
echo ========================================
echo Pokemmo Myself 快速安装脚本
echo ========================================
echo.

echo [1/4] 检查 Node.js...
node -v >nul 2>&1
if errorlevel 1 (
    echo ❌ 未检测到 Node.js，请先安装 Node.js 18+
    echo 下载地址: https://nodejs.org/
    pause
    exit /b 1
)
echo ✅ Node.js 已安装
node -v
echo.

echo [2/4] 安装根目录依赖...
call npm install
if errorlevel 1 (
    echo ❌ 安装失败
    pause
    exit /b 1
)
echo ✅ 根目录依赖安装完成
echo.

echo [3/4] 安装后端依赖...
cd poke-proxy-server
call npm install
if errorlevel 1 (
    echo ❌ 安装失败
    pause
    exit /b 1
)
cd ..
echo ✅ 后端依赖安装完成
echo.

echo [4/4] 检查 Pokemon Showdown...
if exist "..\pokemon-showdown\dist\sim" (
    echo ✅ Pokemon Showdown 已找到
) else (
    echo ⚠️  警告: 未找到 Pokemon Showdown
    echo    请确保 pokemon-showdown 目录在上一级目录
)
echo.

echo ========================================
echo ✅ 安装完成！
echo ========================================
echo.
echo 启动步骤：
echo 1. 打开终端1: cd poke-proxy-server ^&^& node battle-server.js
echo 2. 打开终端2: node simple-http-server.js 8080
echo 3. 打开浏览器: http://localhost:8080/pokemmo.html
echo.
pause
```

#### Linux/Mac Shell 脚本示例

```bash
#!/bin/bash
echo "========================================"
echo "Pokemmo Myself 快速安装脚本"
echo "========================================"
echo

echo "[1/4] 检查 Node.js..."
if ! command -v node &> /dev/null; then
    echo "❌ 未检测到 Node.js，请先安装 Node.js 18+"
    echo "下载地址: https://nodejs.org/"
    exit 1
fi
echo "✅ Node.js 已安装"
node -v
echo

echo "[2/4] 安装根目录依赖..."
npm install
if [ $? -ne 0 ]; then
    echo "❌ 安装失败"
    exit 1
fi
echo "✅ 根目录依赖安装完成"
echo

echo "[3/4] 安装后端依赖..."
cd poke-proxy-server
npm install
if [ $? -ne 0 ]; then
    echo "❌ 安装失败"
    exit 1
fi
cd ..
echo "✅ 后端依赖安装完成"
echo

echo "[4/4] 检查 Pokemon Showdown..."
if [ -d "../pokemon-showdown/dist/sim" ]; then
    echo "✅ Pokemon Showdown 已找到"
else
    echo "⚠️  警告: 未找到 Pokemon Showdown"
    echo "   请确保 pokemon-showdown 目录在上一级目录"
fi
echo

echo "========================================"
echo "✅ 安装完成！"
echo "========================================"
echo
echo "启动步骤："
echo "1. 终端1: cd poke-proxy-server && node battle-server.js"
echo "2. 终端2: node simple-http-server.js 8080"
echo "3. 浏览器: http://localhost:8080/pokemmo.html"
```

---

### 7. 常见问题排查

#### 问题 1：`Cannot find module 'pokemon-showdown'`

**原因**：Pokemon Showdown 库路径不正确

**解决**：
1. 检查 `../pokemon-showdown/dist/sim` 是否存在
2. 如果不存在，需要：
   - 从项目根目录复制 `pokemon-showdown` 目录
   - 或修改代码使用 npm 包

---

#### 问题 2：`npm install` 失败

**可能原因**：
- 网络问题（需要访问 npm registry）
- Node.js 版本不兼容
- 磁盘空间不足

**解决**：
- 使用国内镜像：`npm config set registry https://registry.npmmirror.com`
- 升级 Node.js 到 18+
- 清理磁盘空间

---

#### 问题 3：端口被占用

**错误**：`Error: listen EADDRINUSE: address already in use :::3071`

**解决**：
- 修改 `poke-proxy-server/env.example` 中的端口
- 或关闭占用端口的程序

---

#### 问题 4：前端无法连接后端

**检查**：
1. 后端是否已启动（`node battle-server.js`）
2. 前端服务器地址是否正确
3. 浏览器控制台是否有错误

---

### 8. 最小化部署方案

如果压缩包太大，可以创建**最小化版本**：

**包含**：
- ✅ 源代码
- ✅ `package.json` 和 `package-lock.json`
- ✅ `data/chinese/`（中文数据）
- ✅ `docs/`（文档）

**不包含**：
- ❌ `cache/sprites/`（可以运行时下载）
- ❌ `RAG/data/`（可以运行时构建）
- ❌ `pokemon-showdown-client-master/`（参考代码）

**用户需要额外步骤**：
1. 运行 `npm run proxy` 下载贴图
2. 运行 RAG 构建脚本（如果需要）

---

### 9. 总结

#### ✅ 可以直接使用的条件

1. ✅ 已安装 Node.js 18+
2. ✅ 已运行 `npm install`（两个目录）
3. ✅ Pokemon Showdown 库路径正确
4. ✅ 端口 3071 和 8080 未被占用

#### ⚠️ 需要额外配置的功能

1. ⚠️ RAG 功能需要 Python 环境
2. ⚠️ 高级 AI（难度 5）需要 LLM API 密钥
3. ⚠️ 局域网分享需要配置防火墙

#### 📦 建议的压缩包内容

```
pokemmo-myself.zip
├── 源代码（所有 .js, .html, .json）
├── data/（中文数据）
├── cache/sprites/（精灵贴图，可选但建议）
├── docs/（文档）
├── package.json + package-lock.json（两个目录）
├── 安装说明.md（本文档）
└── 快速开始.bat / 快速开始.sh（安装脚本）
```

#### 🚀 用户需要执行的命令

```bash
# 1. 解压
unzip pokemmo-myself.zip

# 2. 安装依赖（约 5-10 分钟）
cd "pokemmo myself"
npm install
cd poke-proxy-server
npm install
cd ..

# 3. 启动（两个终端）
# 终端1:
cd poke-proxy-server
node battle-server.js

# 终端2:
cd "pokemmo myself"
node simple-http-server.js 8080

# 4. 打开浏览器
# http://localhost:8080/pokemmo.html
```

---

**最后更新**：2025-01-24


# 目录与脚本说明（图示版 · 2025-11-24）
---

## 1. 顶层鸟瞰

```
repo-root
├─ docs/                 ← 文档中心
├─ packages/
│  └─ battle-engine/     ← 前端对战引擎
├─ poke-proxy-server/    ← 后端 WebSocket & AI Server
├─ data/                 ← 原始/本地化资料
├─ cache/                ← 运行期产物（sprites 等）
├─ tools/                ← 根级脚本（manifest、校验…）
├─ tests/                ← 顶层 E2E
├─ RAG/                  ← AI/RAG 实验区
├─ pokemon-showdown-client-master/
├─ *.html                ← 入口页面（pokemmo/pvp-lobby/battle…）
├─ simple-http-server.js ← 静态分享服务器
└─ bundle-size-*.json / validation-report.json
```

- HTML 入口直接 `<script type="module">` 使用 `packages/battle-engine`
- `simple-http-server.js` 便于本地/局域网共享
- CI 输出（bundle-size/validation）也位于根目录

---

## 2. `packages/battle-engine` 结构

```
packages/battle-engine
├─ src/
│  ├─ core/          # BattleEngine、ProtocolParser、StateManager
│  ├─ state-machine/ # BattleStateMachine
│  ├─ phases/        # TeamLoading / TeamPreview / PokemonData / Battle
│  ├─ ui/            # BattleUI、DOM 渲染
│  └─ utils/
│     ├─ Localization.js        # 中文文本
│     ├─ SpriteLoader.js        # 贴图加载
│     ├─ Logger.js
│     ├─ PerformanceMonitor.js  # Web Vitals + 自定义指标
│     ├─ PerformanceReporter.js # 批量上报
│     └─ WebVitalsReporter.js
└─ scripts/
   └─ smoke-test.mjs            # npm run test:engine
```

- `StateManager` + `Phases` = 前端状态机主干
- `scripts/smoke-test.mjs` 被 `npm run test:engine` 调用

---

## 3. `poke-proxy-server` 结构

```
poke-proxy-server
├─ battle-server.js          # 启动入口
├─ config/
│  ├─ index.js               # 环境变量解析
│  └─ schema.js
├─ server/
│  ├─ bootstrap.js           # HTTP + WS + API
│  ├─ metricsEndpoint.js
│  ├─ metricsApiEndpoint.js  # 接收前端性能上报
│  └─ healthEndpoint.js
├─ controllers/
│  ├─ connectionController.js
│  ├─ AIBattleController.js
│  └─ PvPController.js
├─ domain/
│  ├─ battles/   # BattleManager / SimplePvPManager
│  ├─ choices/   # PlayerChoiceHandler 等
│  └─ rooms/     # Room / RoomManager
├─ adapters/
│  ├─ logging/
│  ├─ metrics/
│  ├─ resources/ # 中文数据、sprite 管理
│  └─ pokemon-showdown/
├─ core/
│  ├─ ai/        # Simple/Medium/Advanced/Expert AI
│  ├─ PvPHandler.js
│  ├─ WebSocketDiagnostics.js
│  └─ tools/     # 伤害计算、属性克制
└─ tests/
   ├─ unit/*.test.js
   └─ integration/websocket-smoke.test.js (需 RUN_INTEGRATION_TESTS=true)
```

- `battle-server.js` 负责加载配置、构建 RoomManager、注册控制器
- `core/ai` 下存放所有 AI 策略
- `tests/` 同时包含单测与集成冒烟

---

## 4. 数据与缓存

```
data/
├─ chinese/*.json     # 宝可梦/技能/道具/特性中文
├─ data-manifest.json # 由脚本生成
└─ scripts/
   ├─ fetch-pokemon-cn.mjs
   └─ download-missing-sprites.mjs

cache/
├─ sprites/                 # 已下载贴图
├─ sprites-manifest.json
└─ missing-sprites.json     # 下载失败列表
```

- `data/scripts/*` 用于抓取/整理数据
- `cache/` 仅存储运行期/下载后的产物

---

## 5. 根级 `tools/` 脚本

```
tools/
├─ generate-sprites-manifest.mjs  # npm run manifest:sprites
├─ generate-data-manifest.mjs     # npm run manifest:data
├─ validate-resources.mjs         # npm run validate:resources / sprites / data
├─ check-bundle-size.mjs          # npm run check:bundle-size
└─ resource-proxy.js              # npm run proxy
```

- 所有脚本均通过 npm script 触发，避免手动 node 调用
---
## 6. 其他入口 & 可选组件

```
root-level extras
├─ simple-http-server.js  # 本地静态服务器 (npm run share? 手动 node)
├─ RAG/
│  ├─ run_kb_setup.py
│  └─ scripts/*           # 知识库、向量化、Dashscope 集成
├─ tests/e2e/*.js         # Playwright 入口 (npm run test:e2e*)
└─ .github/workflows/ci.yml
```

- `RAG/` 可选：对 ExpertAI / 策略编辑器提供知识库支持

---

## 7. npm Scripts（图解）

```
npm scripts
├─ battle             -> node poke-proxy-server/battle-server.js
├─ proxy              -> node tools/resource-proxy.js
├─ manifest:sprites   -> node tools/generate-sprites-manifest.mjs
├─ manifest:data      -> node tools/generate-data-manifest.mjs
├─ validate:resources -> node tools/validate-resources.mjs
├─ check:bundle-size  -> node tools/check-bundle-size.mjs
├─ test:engine        -> node packages/battle-engine/scripts/smoke-test.mjs
└─ test:e2e*          -> playwright test ...

poke-proxy-server/package.json
└─ npm test / npm run test:coverage (Jest, 需先 cd 进入)
```

> 新脚本或目录需同步此文档，并在 `package.json` 登记，确保团队成员与 CI 一致。

---



# 目录与脚本说明（2025-11-19）

> 本文按“目录 → 子目录/文件 → 用途”进行整理，覆盖当前仓库中主要组件、工具脚本及其对应的 npm script。便于新同学快速查找入口，也方便重构后确认依赖关系。

---

## 1. 顶层目录

| 目录 | 说明 |
| ---- | ---- |
| `/docs/` | 项目文档（架构、模块、部署、测试等）。新增文档也放在此处。 |
| `/packages/` | 前端可复用模块，当前仅有 `battle-engine`（对战引擎）。 |
| `/poke-proxy-server/` | 后端 WebSocket & AI Battle Server，负责 AI/PvP 对战、指标、健康检查。 |
| `/data/` | 官方及本地化数据源（pokedex、moves、中文翻译、脚本）。配套 manifest 与下载脚本。 |
| `/cache/` | 运行期缓存与生成物，如 `sprites/`、`sprites-manifest.json`。 |
| `/tools/` | 根级资源/构建脚本（manifest 生成、校验、资源代理、bundle 体积）。通过 npm scripts 调用。 |
| `/tests/` | 顶层测试目录，目前包含 Playwright E2E。后端 Jest 测试在 `poke-proxy-server/tests`。 |
| `/pokemon-showdown-client-master/` | 上游 Pokemon Showdown 前端源码，用于比对与资源提取。 |
| `/RAG/` | AI/RAG 实验脚本与数据，可选模块。 |
| `*.html`（`pokemmo.html`、`pvp-lobby.html`、`battle.html` 等） | 传统入口页面，通过 `<script type="module">` 调用 `packages/battle-engine`。 |
| `simple-http-server.js` | 本地静态资源服务器，配合 HTML 入口分享/调试使用。 |
| `bundle-size-*.json`、`validation-report.json` | CI/脚本输出，记录 bundle/资源校验结果。 |

---

## 2. `/packages/battle-engine`

| 路径 | 用途 |
| ---- | ---- |
| `src/core/` | BattleEngine、ProtocolParser、StateManager 等核心逻辑。 |
| `src/state-machine/` | BattleStateMachine 及状态转换逻辑。 |
| `src/phases/` | TeamLoading/TeamPreview/PokemonData/Battle 四个 Phase。 |
| `src/ui/` | BattleUI 与 DOM 渲染、事件绑定。 |
| `src/utils/Localization.js` | 中文翻译 & 文本辅助。 |
| `src/utils/SpriteLoader.js` | 贴图 URL 生成 & 加载。 |
| `src/utils/Logger.js` | 前端日志输出。 |
| `src/utils/PerformanceMonitor.js` | Web Vitals + 自定义性能指标采集。 |
| `src/utils/PerformanceReporter.js` | 批量上报性能数据至 `/api/metrics`。 |
| `src/utils/WebVitalsReporter.js` | 封装 `web-vitals`，自动与 Reporter 协作。 |
| `scripts/smoke-test.mjs` | 前端引擎冒烟测试（由 `npm run test:engine` 调用）。 |

---

## 3. `/poke-proxy-server`

| 路径 | 用途 |
| ---- | ---- |
| `battle-server.js` | 入口：加载配置、资源、创建 RoomManager/PvPHandler，调用 `server/bootstrap`。 |
| `config/index.js` + `config/schema.js` | 环境变量解析与校验。 |
| `server/bootstrap.js` | HTTP + WebSocket 引导，挂载 `/metrics`、`/api/metrics`、`/health`。 |
| `server/metricsEndpoint.js` | Prometheus 指标端点。 |
| `server/metricsApiEndpoint.js` | 接收 BattleEngine 前端性能上报、提供查询。 |
| `server/healthEndpoint.js` | `/health`、`/health/ready`、`/health/live`、`/api/diagnostics`。 |
| `controllers/connectionController.js` | WS 连接生命周期、消息路由。 |
| `controllers/AIBattleController.js` | 处理 AI 对战 start/choose 流程。 |
| `controllers/PvPController.js` | 房间创建、加入、start 路由。 |
| `domain/battles/*` | BattleManager（AI）、SimplePvPManager（PvP）。 |
| `domain/choices/*` | PlayerChoiceHandler、AIChoiceHandler、ProtocolRouter。 |
| `domain/rooms/*` | Room 与 RoomManager（含 `getStats()`）。 |
| `adapters/logging/*` | Logger、LogAggregator、formatters。 |
| `adapters/metrics/*` | Prometheus 指标注册 & WebSocket 包装器。 |
| `adapters/resources/*` | 中文数据 Loader 与 SpriteFileManager。 |
| `adapters/pokemon-showdown/*` | Dex/Teams/BattleStream/RandomTeams 适配。 |
| `core/ai/*` | Simple/Medium/Advanced/Expert AI 策略与工具。 |
| `core/PvPHandler.js` | PvP 房间/重连封装（连接控制器注入）。 |
| `core/WebSocketDiagnostics.js` | WS 数据收集与调试输出。 |
| `core/tools/*` | 伤害计算、属性克制、策略辅助。 |
| `tests/unit/*.test.js` | Room、RoomManager、BattleManager 等单测。 |
| `tests/integration/websocket-smoke.test.js` | WS 冒烟测试（运行需 `RUN_INTEGRATION_TESTS=true`）。 |

---

## 4. `/data` 与 `/cache`

| 路径 | 用途 |
| ---- | ---- |
| `data/chinese/*.json` | 中文翻译数据：宝可梦、技能、道具、特性。 |
| `data/data-manifest.json` | 数据资源 manifest（由脚本生成）。 |
| `data/scripts/*.mjs` | 抓取/整理中文数据、缺失 sprites 的脚本。 |
| `cache/sprites/` | 已下载的本地精灵贴图。 |
| `cache/sprites-manifest.json` | Sprites Manifest（供前端/校验脚本使用）。 |
| `missing-sprites.json` | 未下载成功的贴图列表。 |

---

## 5. `/tools`（根级脚本）

| 文件 | 描述 | 触发方式 |
| ---- | ---- | ---- |
| `generate-sprites-manifest.mjs` | 遍历 `cache/sprites/`，生成 manifest。 | `npm run manifest:sprites` |
| `generate-data-manifest.mjs` | 汇总 `data/` 下资源，生成 manifest。 | `npm run manifest:data` |
| `validate-resources.mjs` | 校验 Sprites/数据文件是否存在、体积/MD5 是否匹配，可传 `--type=`。 | `npm run validate:resources` / `validate:sprites` / `validate:data` |
| `check-bundle-size.mjs` | 读取打包产物体积，与 `bundle-size-history.json` 对比。 | `npm run check:bundle-size` |
| `resource-proxy.js` | 启动资源代理，帮助在本地抓取 sprites/数据。 | `npm run proxy` |

---

## 6. 其他脚本与入口

| 文件 | 位置 | 用途 |
| ---- | ---- | ---- |
| `simple-http-server.js` | 根目录 | 提供静态 HTTP 服务，便于局域网/公网分享 HTML 入口。 |
| `packages/battle-engine/scripts/smoke-test.mjs` | packages | 前端冒烟测试，验证 BattleEngine 可建立连接。 |
| `data/scripts/download-missing-sprites.mjs` | data/scripts | 根据 `missing-sprites.json` 自动下载缺失贴图。 |
| `data/scripts/fetch-pokemon-cn.mjs` | data/scripts | 抓取中文百科数据，刷新 `data/chinese/*.json`。 |
| `RAG/run_kb_setup.py`、`RAG/scripts/*` | RAG | 构建/更新本地知识库、向量化等（可选组件）。 |
| `tests/e2e/*.js` | 根/tests | Playwright 端到端测试入口（`npm run test:e2e`）。 |
| `.github/workflows/ci.yml`（未在此表中列出） | GitHub Actions | Lint、测试、资源校验、E2E、bundle 检查。 |

---

## 7. npm scripts（根层重点）

| 命令 | 实际执行 | 说明 |
| ---- | ---- | ---- |
| `npm run battle` | `node poke-proxy-server/battle-server.js` | 启动后端对战服务器。 |
| `npm run proxy` | `node tools/resource-proxy.js` | 资源代理/下载。 |
| `npm run manifest:sprites` | `node tools/generate-sprites-manifest.mjs` | Sprites manifest 生成。 |
| `npm run manifest:data` | `node tools/generate-data-manifest.mjs` | 数据 manifest 生成。 |
| `npm run validate:resources` | `node tools/validate-resources.mjs` | 资源完整性校验。 |
| `npm run check:bundle-size` | `node tools/check-bundle-size.mjs` | 构建产物体积检测。 |
| `npm run test:engine` | `node packages/battle-engine/scripts/smoke-test.mjs` | BattleEngine 冒烟测试。 |
| `npm run test:e2e*` | `playwright test ...` | E2E/UI/有头模式测试。 |

> 后端 `poke-proxy-server/package.json` 还提供 `npm test` / `npm run test:coverage` 等 Jest 命令；执行前需 `cd poke-proxy-server`。

---

如需补充新的目录或脚本，请同步更新本文并在 `package.json` 的 npm scripts 中登记，确保 CI/团队成员可以直接调用。***


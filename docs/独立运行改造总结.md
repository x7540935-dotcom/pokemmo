# 独立运行改造总结

> 本文档总结已完成的改造，使项目可以完全独立运行，无需外部 Pokemon Showdown 文件。

---

## ✅ 已完成的改造

### 1. ShowdownAdapter 智能加载机制 ✅

**文件**：`poke-proxy-server/adapters/pokemon-showdown/ShowdownAdapter.js`

**改进内容**：
- ✅ 实现了智能检测机制（`_detectShowdownModule()`）
  - 优先检测 npm 包（node_modules 中的 `pokemon-showdown`）
  - 降级到本地路径（`../../../../pokemon-showdown`）
  
- ✅ 实现了智能加载机制（`_requireShowdownModule()`）
  - 支持从 npm 包加载（多种路径尝试）
  - 支持从 node_modules 加载（GitHub 依赖）
  - 支持从本地路径加载（向后兼容）

- ✅ 所有方法都使用统一接口
  - `getDex()` - 自动选择最佳加载方式
  - `getTeams()` - 自动选择最佳加载方式
  - `getBattleStreamClass()` - 自动选择最佳加载方式
  - `getPlayerStreamsFn()` - 自动选择最佳加载方式
  - `getRandomTeamsClass()` - 自动选择最佳加载方式

### 2. BattleManager 使用适配层 ✅

**文件**：`poke-proxy-server/core/BattleManager.js`

**改进内容**：
- ✅ 移除了直接路径引用 `../../../pokemon-showdown/dist/sim`
- ✅ 统一使用 `showdownAdapter` 获取模块
- ✅ 支持 npm 包和本地路径两种方式

### 3. package.json 配置 ✅

**文件**：`poke-proxy-server/package.json`

**改进内容**：
- ✅ 添加 GitHub 依赖：
  ```json
  "pokemon-showdown": "https://github.com/smogon/pokemon-showdown.git#master"
  ```
- ✅ 添加 postinstall 脚本：
  ```json
  "postinstall": "node scripts/install-showdown.js"
  ```

### 4. 自动安装脚本 ✅

**文件**：`poke-proxy-server/scripts/install-showdown.js`

**功能**：
- ✅ 检查 npm 包是否可用
- ✅ 检查本地路径是否存在
- ✅ 自动从 GitHub 克隆（如果需要）
- ✅ 自动构建（如果需要）
- ✅ 详细的日志输出

---

## 🎯 改造效果

### 改造前

**用户需要做的**：
1. ❌ 解压项目
2. ❌ 手动准备 `pokemon-showdown` 目录
3. ❌ 确保目录结构正确（`pokemmo/pokemon-showdown`）
4. ❌ 安装依赖
5. ❌ 启动服务

**问题**：
- 需要手动操作
- 容易出错（路径不对）
- 无法独立运行

### 改造后

**用户需要做的**：
1. ✅ 解压项目
2. ✅ 运行 `npm install`（2个目录）
3. ✅ 启动服务

**自动完成**：
- ✅ npm 自动从 GitHub 下载 `pokemon-showdown`
- ✅ 自动检测并使用正确的加载方式
- ✅ 完全独立，无需外部文件

---

## 📦 使用流程

### 步骤 1：解压

```bash
unzip pokemmo-myself.zip
cd "pokemmo myself"
```

### 步骤 2：安装依赖

```bash
# 根目录
npm install

# 后端目录（会自动安装 pokemon-showdown）
cd poke-proxy-server
npm install
```

**自动执行**：
- npm 从 GitHub 克隆 `pokemon-showdown` 到 `node_modules`
- 如果 GitHub 克隆失败，postinstall 脚本会尝试自动克隆

### 步骤 3：启动服务

```bash
# 终端1：启动后端
cd poke-proxy-server
node battle-server.js

# 终端2：启动前端
cd ..
node simple-http-server.js 8080
```

### 步骤 4：打开浏览器

```
http://localhost:8080/pokemmo.html
```

---

## 🔍 验证方法

改造完成后，可以这样验证：

```bash
# 1. 清理环境（模拟新用户）
rm -rf poke-proxy-server/node_modules
rm -rf pokemon-showdown  # 如果存在

# 2. 重新安装
cd poke-proxy-server
npm install

# 3. 检查是否成功
# 应该能看到：
# - ✅ npm 包已安装到 node_modules
# - ✅ [ShowdownAdapter] ✅ 检测到 npm 包: pokemon-showdown

# 4. 启动服务器
node battle-server.js
# 应该能看到：✅ 检测到 npm 包 或 ✅ 本地路径已存在
```

---

## ⚙️ 配置选项

### 环境变量

如果不想自动安装，可以设置：

```bash
SKIP_SHOWDOWN_INSTALL=1 npm install
```

### 指定版本

可以修改 `package.json` 中的版本：

```json
{
  "dependencies": {
    "pokemon-showdown": "https://github.com/smogon/pokemon-showdown.git#v1.2.3"
  }
}
```

---

## 🐛 故障排查

### 问题 1：npm install 失败

**可能原因**：
- 网络问题（无法访问 GitHub）
- Git 未安装

**解决方案**：
1. 检查网络连接
2. 安装 Git：`https://git-scm.com/`
3. 或手动克隆：`git clone https://github.com/smogon/pokemon-showdown.git ../../../pokemon-showdown`

### 问题 2：启动时提示"无法加载 Pokemon Showdown"

**可能原因**：
- npm 包未正确安装
- 本地路径不存在

**解决方案**：
1. 重新运行 `npm install`
2. 检查 `node_modules/pokemon-showdown` 是否存在
3. 检查日志，查看使用了哪种加载方式

---

## 📚 相关文档

- `docs/architecture/独立运行改造方案-最终版.md` - 详细方案说明
- `docs/部署分析-压缩包分发指南.md` - 部署指南

---

**最后更新**：2025-01-24


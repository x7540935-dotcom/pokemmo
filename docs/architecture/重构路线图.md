# 重构路线图（Refactor Roadmap）

> 版本：2025-11-18  
> 负责人：Pokemmo Myself Maintainers

---

## 目标

- **降体积**：资源去重、模块拆分、按需加载
- **提可维护性**：清晰分层、职责单一、可测试
- **提可观测性**：统一日志、指标与调试工具
- **提交付效率**：标准化脚本、CI 守卫、自动化文档

---

## 阶段划分

### Phase 0｜基线清理（已完成）
- 盘点工具脚本，删除 `tools/ts2json.js`
- 重写 README、开发/架构/模块文档
- 建立路线图（本文档）

### Phase 1｜架构蓝图与文档整合（已完成）
- 统一命名与模块边界（前端核心 = `packages/battle-engine`)
- 描述“现状 vs 目标”架构，形成决策记录
- 识别必须保留的遗留入口（独立 HTML）

### Phase 2｜前端模块化（已完成）
- 第一步：将 `battle-system` 拆分为 `packages/battle-engine`（✅）
- 第二步：为 battle-engine 建立正式构建产物（Vite/Rollup/tsup）并输出 `dist/`（✅）
- 第三步：将 HTML 入口迁移到新路由/SPA，逐步移除 legacy shim（✅）
- 引入按需加载 + Tree-shaking，并补充冒烟/单元测试（✅ 冒烟测试已覆盖核心流程）

### Phase 3｜后端分层（已完成）
- ✅ 拆分 `poke-proxy-server/battle-server.js` 为分层入口（bootstrap / controllers / domain）
- ✅ 已落地配置中心（dotenv + schema 校验）与服务器引导层
- ✅ `RoomManager` / `BattleManager` / `SimplePvPManager` / `ProtocolRouter` / ChoiceHandlers 均迁入 `domain/*`
- ✅ 基础设施适配层（Pokemon Showdown、资源加载、日志）已创建并接入
- ✅ 统一日志系统已接入 domain/controllers
- ✅ 单元测试和集成测试框架已建立（Jest + WebSocket 冒烟测试）

### Phase 4｜资源流水线与自动化（进行中）
- ✅ 详细计划已制定（见 `docs/architecture/Phase4-资源流水线详细计划.md`）
- ✅ Step 1：资源清单生成（Manifest System）
  - ✅ Sprites Manifest 生成器（`tools/generate-sprites-manifest.mjs`）
  - ✅ 数据 Manifest 生成器（`tools/generate-data-manifest.mjs`）
  - ✅ 集成到 npm scripts（`npm run manifest:all`）
- ✅ Step 2：资源校验脚本
  - ✅ 资源校验脚本（`tools/validate-resources.mjs`）
  - ✅ 文件存在性、大小、MD5 校验
  - ✅ 版本一致性检查
  - ✅ 集成到 npm scripts（`npm run validate:resources`）
- ✅ Step 3：CI/CD 配置（ESLint、GitHub Actions）
  - ✅ ESLint 配置（`.eslintrc.js`、`.eslintignore`）
  - ✅ 体积阈值检查脚本（`tools/check-bundle-size.mjs`）
  - ✅ GitHub Actions CI 工作流（`.github/workflows/ci.yml`）
  - ✅ 集成到 npm scripts（`npm run lint`、`npm run check:bundle-size`）
- ✅ Step 4：E2E 冒烟测试（Playwright）
  - ✅ Playwright 配置（`playwright.config.js`）
  - ✅ E2E 测试文件（`tests/e2e/smoke.test.js`）
  - ✅ 集成到 GitHub Actions CI
  - ✅ 集成到 npm scripts（`npm run test:e2e`）
- ⏳ Step 5：资源优化（差分补丁、CDN 缓存，可选）

### Phase 5｜观测 & 发布（进行中）
- ✅ 详细计划已制定（见 `docs/architecture/Phase5-观测与发布详细计划.md`）
- ✅ Step 1：统一日志系统增强
  - ✅ 日志格式化器（JSON、文本）
  - ✅ 日志文件写入器（支持轮转）
  - ✅ 日志聚合器（内存缓存、查询、统计）
  - ✅ Logger 增强（支持 fatal 级别、文件输出、聚合）
- ✅ Step 2：WebSocket 事件指标（Prometheus）
  - ✅ Prometheus 指标收集器（PrometheusMetrics.js）
  - ✅ WebSocket 指标跟踪器（WebSocketMetrics.js）
  - ✅ 指标端点（/metrics）
  - ✅ 集成到连接控制器和服务器引导
- ✅ Step 3：前端性能监控（Web Vitals）
  - ✅ Web Vitals 集成（PerformanceMonitor.js、WebVitalsReporter.js）
  - ✅ 自定义性能埋点（WebSocket 连接、协议接收、阶段转换）
  - ✅ 性能数据上报（PerformanceReporter.js）
  - ✅ 后端 API 端点（/api/metrics）
  - ✅ 集成到 BattleEngine 和 BattleStateMachine
- ✅ Step 4：健康检查端点
  - ✅ `/health`、`/health/live`、`/health/ready` 基础与就绪检查
  - ✅ `/api/diagnostics` 诊断信息（连接、房间、对战、日志）
  - ✅ 集成房间/对战/资源统计、日志聚合器
- ⏳ Step 5：版本管理和变更日志
- ⏳ Step 6：回滚策略和部署

---

## 任务看板（示例）

| 编号 | 描述 | 负责人 | 状态 |
| ---- | ---- | ---- | ---- |
| P3-01 | 落地后端配置中心（.env + schema + ConfigService） | AI | ✅ |
| P3-02 | 拆分 `battle-server.js` 为 `bootstrap` + `controllers` | AI | ✅ |
| P3-03 | 迁移 `RoomManager` / `Room` 至 `domain/rooms` | AI | ✅ |
| P3-04 | 迁移 `BattleManager` / `SimplePvPManager` 至 `domain/battles` | AI | ✅ |
| P3-05 | 抽离 `ProtocolRouter` / ChoiceHandlers 至 `domain/choices` | AI | ✅ |
| P3-06 | 单元 + 集成测试（Jest + WebSocket 冒烟） | AI | ✅ |
| P4-01 | 创建 Sprites Manifest 生成器 | AI | ✅ |
| P4-02 | 创建数据 Manifest 生成器 | AI | ✅ |
| P4-03 | 集成 manifest 生成到 npm scripts | AI | ✅ |
| P4-04 | 创建资源校验脚本 | AI | ✅ |
| P4-05 | 设置 ESLint 配置 | AI | ✅ |
| P4-06 | 创建 GitHub Actions CI 工作流 | AI | ✅ |
| P4-07 | 创建体积阈值检查脚本 | AI | ✅ |
| P4-08 | 设置 Playwright E2E 测试 | AI | ✅ |
| P4-09 | 编写 E2E 冒烟测试 | AI | ✅ |
| P4-10 | 更新文档 | AI | ✅ |
| P5-00 | 制定 Phase 5 详细计划 | AI | ✅ |
| P5-01 | 统一日志系统增强 | AI | ✅ |
| P5-02 | WebSocket 事件指标（Prometheus） | AI | ✅ |
| P5-03 | 前端性能监控（Web Vitals） | AI | ✅ |
| P5-04 | 健康检查端点 | AI | ✅ |
| P5-05 | 版本管理和变更日志 | AI | ⏳ |
| P5-06 | 回滚策略和部署 | AI | ⏳ |

---

## 里程碑验收标准

- **前端**：单页面构建成功、核心逻辑 80% 单测覆盖、bundle size 报告
- **后端**：模块拆分完成、handler 单测 + 集成测试、WS 压测脚本
- **资源**：manifest 自动生成、缺失检测在 CI 中运行
- **文档**：每次架构变更追加 ADR / 设计说明

---

## 协作方式

1. 每个阶段创建 `docs/architecture/adr/ADR-xxxx.md`
2. PR 模板包含：
   - 对应阶段/任务编号
   - 测试/验证信息
   - 体积或性能影响
3. 每周同步重构进度，必要时调整路线

---

## 附录

- 相关文档：
  - `docs/项目开发文档.md`
  - `docs/架构说明文档.md`
  - `docs/modules/前端模块说明.md`
  - `docs/modules/后端模块说明.md`
- 工具与脚本：
  - `npm run battle`
  - `npm run proxy`
  - `node simple-http-server.js`


# 后端分层重构计划（Phase 3）

> 更新时间：2025-11-18  
> 范围：`pokemmo myself/poke-proxy-server`

---

## 1. 现状速览

```
battle-server.js                     # 入口，仍包含部分资源/AI 辅助函数
domain/
  rooms/ (Room.js, RoomManager.js)   # ✅ 已迁移
  battles/ (BattleManager.js, SimplePvPManager.js) # ✅ 已迁移
  choices/ (PlayerChoiceHandler.js, AIChoiceHandler.js, ProtocolRouter.js) # ✅ 已迁移
core/
  PvPHandler.js                      # 仍待迁移到应用层
  ai/                                # Simple/Medium/Advanced/Expert AI 策略
  tools/                             # 伤害、克制、评估工具
config/                              # dotenv + schema
server/                              # bootstrap（WS/HTTP 引导）
controllers/                         # connection / AI / PvP 控制器
```

痛点：
- `battle-server.js` 同时负责 **HTTP/WS 启动、配置加载、资源检查、AI 队伍生成、房间调度**。
- 关键常量散落在文件顶部，仅依赖 `process.env`，测试/部署难以注入。
- 缺少分层界限（Controller vs Domain vs Infrastructure），也没有统一日志/错误定义。
- 无自动化测试（BattleManager、RoomManager、Handler 都只能靠手测）。

---

## 2. 目标架构

```
poke-proxy-server/
├─ server/
│  ├─ bootstrap.js          # HTTP + WS 初始化（只处理框架级逻辑）
│  └─ routes.js             # 将 ws 连接交给控制器
├─ config/
│  ├─ index.js              # 读取 env / 默认值
│  └─ schema.js             # zod / joi 校验
├─ controllers/
│  ├─ AIBattleController.js # 解析 start/choose（AI）
│  ├─ PvPController.js      # 房间创建、重连、透传协议
│  └─ DiagnosticsController.js (可选)
├─ domain/
│  ├─ battles/
│  │  ├─ BattleManager.js
│  │  ├─ SimplePvPManager.js
│  │  └─ ProtocolRouter.js
│  ├─ rooms/
│  │  ├─ Room.js
│  │  └─ RoomManager.js
│  └─ choices/
│     ├─ PlayerChoiceHandler.js
│     └─ AIChoiceHandler.js
├─ infrastructure/
│  ├─ showdowndex/          # 与 pokemon-showdown 的适配层（Teams/Dex/RandomTeams）
│  ├─ resources/            # 中文数据、sprites 缓存
│  └─ logging/
│     └─ Logger.js
├─ tests/
│  ├─ unit/                 # RoomManager、BattleManager
│  └─ integration/          # ws 冒烟
└─ battle-server.js         # 仅负责调用 server/bootstrap
```

---

## 3. 实施步骤

### Step 1｜配置中心
1. 新建 `config/schema.js`，使用 zod/joi 定义：
   - `BATTLE_PORT`（default 3071）
   - `DEBUG_AI`
   - `DATA_ROOT`、`SPRITES_DIR` 等路径
2. `config/index.js` 读取 `.env` + 默认值，导出只读对象。
3. `battle-server.js`/`BattleManager` 等模块仅依赖 `config`，去除随处可见的 `process.env`.

### Step 2｜服务器引导 & 控制器（进行中）
1. ✅ `server/bootstrap.js`：封装 HTTP + WS 启动、统一日志输出。
2. ✅ `controllers/connectionController.js`：承载原 `wss.on('connection')` 逻辑，注入 `roomManager/pvpHandler`/helpers。
3. ✅ `AIBattleController` / `PvPController`：拆分业务控制器，统一由 `connectionController` 路由消息。
4. ⏳ `battle-server.js` 退化为纯依赖注入（剩余资源加载、AI 队伍工具将在 Phase 3.4 迁出）。
   ```js
   const bootstrap = require('./server/bootstrap');
   bootstrap();
   ```

### Step 3｜领域对象梳理
1. ✅ `BattleManager` / `SimplePvPManager` 已迁入 `domain/battles`，仅处理 BattleStream + 协议缓存。
2. ✅ `RoomManager` / `Room` 已迁入 `domain/rooms`，控制器通过依赖注入获得领域实例。
3. ✅ `ProtocolRouter` 与 `Player/AiChoiceHandler` 迁入 `domain/choices`，统一出口、方便测试。
4. ⏳ Room 事件化 & handler 抽象（计划在 PvP 重构时补完）。

### Step 4｜基础设施抽象 ✅
1. ✅ `adapters/pokemon-showdown/ShowdownAdapter`：封装对 `pokemon-showdown/dist/*` 的访问，提供统一接口（Dex, Teams, BattleStream, RandomTeams），便于测试时 mock。
2. ✅ `adapters/resources/ChineseDataLoader`：负责读取 `data/chinese/`，提供缓存 + watch 功能。
3. ✅ `adapters/resources/SpriteFileManager`：管理本地贴图文件目录，提供文件存在性检查和缓存。
4. ✅ `adapters/logging/Logger`：统一日志接口，支持模块前缀、日志级别（debug/info/warn/error）、JSON 输出，兼容 `DEBUG_AI`。
5. ✅ 更新 `domain/battles/BattleManager`、`SimplePvPManager`、`battle-server.js`、`PvPHandler`、`DamageCalculator` 使用适配层。

### Step 5｜测试与工具 ✅
1. ✅ Unit Test（Jest）：
   - ✅ `Room`：玩家管理、队伍设置、广播、状态管理
   - ✅ `RoomManager`：创建/加入/超时清理/队伍验证
   - ✅ `BattleManager`：初始化、连接管理、选择处理（mock BattleStream）
2. ✅ Integration Test：
   - ✅ WebSocket 连接测试
   - ✅ AI 对战启动流程测试
   - ✅ PvP 房间创建流程测试
3. ✅ 脚本：
   - ✅ `npm test`：执行测试套件
   - ✅ `npm run test:watch`：监视模式
   - ✅ `npm run test:coverage`：生成覆盖率报告

---

## 4. 任务拆解（Phase 3 backlog）
| 编号 | 任务 | 说明 | 状态 |
| ---- | ---- | ---- | ---- |
| P3-01 | 配置中心 & schema | 完成 Step1，替换散落常量 | ✅ |
| P3-02 | server/bootstrap & controllers | 重写入口，确保 ws 路由清晰 | ✅ |
| P3-03 | 迁移领域层 | rooms / battles / choices 全量迁移 | ✅ |
| P3-04 | 资源适配层 | 封装 Pokemon Showdown、中文数据/贴图加载、统一日志 | ✅ |
| P3-05 | 日志 + 监控 hooks | 统一 logger、准备观测点（Logger 已创建，domain/controllers 已接入） | ✅ |
| P3-06 | 单元 + 集成测试 | Jest + ws 冒烟（Room/RoomManager/BattleManager 单元测试 + WebSocket 集成测试） | ✅ |

---

## 5. 里程碑验收
- **配置**：`.env` + `config/` 成功驱动 server，CI 中可注入。
- **结构**：`battle-server.js` < 100 行，职责仅限引导。
- **测试**：`npm run test:backend` 通过（含 Room/Battle 单测 + ws 冒烟）。
- **文档**：更新 `docs/modules/后端模块说明.md` 与路线图，描述新分层。


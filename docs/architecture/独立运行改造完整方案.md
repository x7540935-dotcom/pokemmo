# 独立运行改造完整方案：移除外部 Pokemon Showdown 文件依赖

> 本文档提供完整的改造方案，使项目解压后安装依赖即可直接运行，无需额外的 Pokemon Showdown 文件。

---

## 📋 问题分析

### 当前依赖情况

1. **硬编码路径**：
   - `ShowdownAdapter.js`: `../../../../pokemon-showdown`
   - `BattleManager.js`: `../../../pokemon-showdown/dist/sim`

2. **外部文件要求**：
   - 需要 `pokemmo/pokemon-showdown` 目录存在
   - 需要编译后的 `dist/sim` 目录

3. **部署困难**：
   - 压缩包必须包含 pokemon-showdown 目录
   - 或者要求用户手动准备

---

## 🎯 解决方案对比

### 方案 A：使用 npm 包（推荐）

**优点**：
- ✅ 完全独立，无需外部文件
- ✅ 版本锁定（package-lock.json）
- ✅ 自动管理依赖
- ✅ 跨平台兼容

**缺点**：
- ⚠️ 需要找到合适的 npm 包
- ⚠️ 可能需要验证 API 兼容性

**实现**：
- 添加 `pokemon-showdown` 或 `@pkmn/sim` 到 package.json
- 修改 ShowdownAdapter 使用 require('包名')

### 方案 B：Git 子模块（次选）

**优点**：
- ✅ 保持与上游同步
- ✅ 版本控制清晰

**缺点**：
- ❌ 需要 Git
- ❌ 用户需要执行 `git submodule update`

### 方案 C：安装脚本自动下载（最实用）

**优点**：
- ✅ 完全自动化
- ✅ 不依赖 npm 包可用性
- ✅ 灵活控制版本

**缺点**：
- ❌ 需要网络连接（首次安装）
- ❌ 增加安装时间

**实现**：
- 创建 `install-showdown.js` 脚本
- 在 `npm install` 后自动执行
- 从 GitHub 克隆或下载 pokemon-showdown

### 方案 D：包含在项目中（不推荐）

**优点**：
- ✅ 完全独立

**缺点**：
- ❌ 压缩包很大（50-100 MB）
- ❌ 难以更新

---

## 🔧 推荐方案：方案 C（自动安装脚本）+ 方案 A（npm 降级）

### 实现步骤

#### 步骤 1：创建安装脚本

创建 `poke-proxy-server/scripts/install-showdown.js`：

```javascript
/**
 * 自动安装 Pokemon Showdown 脚本
 * 
 * 功能：
 * - 检查 pokemon-showdown 是否已存在
 * - 如果不存在，从 GitHub 克隆或下载
 * - 如果存在但版本不对，更新
 * 
 * 执行方式：
 * - 在 package.json 的 postinstall 脚本中调用
 * - 或手动运行：node scripts/install-showdown.js
 */
```

#### 步骤 2：修改 ShowdownAdapter

已完成的修改：
- ✅ 优先尝试 npm 包（`@pkmn/sim`, `pokemon-showdown`）
- ✅ 降级到本地路径（`../../../../pokemon-showdown`）
- ✅ 智能检测和错误处理

#### 步骤 3：添加 postinstall 脚本

在 `poke-proxy-server/package.json` 中添加：

```json
{
  "scripts": {
    "postinstall": "node scripts/install-showdown.js"
  }
}
```

#### 步骤 4：更新依赖说明

---

## 📝 具体实现

### 1. 修改 ShowdownAdapter.js（已完成）

已实现智能加载策略：
- 优先尝试 npm 包
- 降级到本地路径
- 详细错误提示

### 2. 修改 BattleManager.js（已完成）

已将直接引用改为使用适配层。

### 3. 创建安装脚本

让我创建这个脚本...


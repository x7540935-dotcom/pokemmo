# 独立运行改造方案（最终版）：完全独立部署

> 本文档提供完整的改造方案，使项目解压后只需运行 `npm install` 即可直接使用，无需任何外部 Pokemon Showdown 文件。

---

## 🎯 改造目标

**改造前**：
- ❌ 需要手动准备 `pokemon-showdown` 目录
- ❌ 需要特定的目录结构
- ❌ 无法独立运行

**改造后**：
- ✅ 解压后直接运行 `npm install`
- ✅ 自动处理 Pokemon Showdown 依赖
- ✅ 完全独立，无需外部文件

---

## 🔧 已完成的改造

### 1. ShowdownAdapter 智能加载 ✅

**文件**：`poke-proxy-server/adapters/pokemon-showdown/ShowdownAdapter.js`

**改进**：
- ✅ 优先尝试 npm 包（`@pkmn/sim`, `pokemon-showdown`）
- ✅ 自动降级到本地路径（向后兼容）
- ✅ 智能检测和错误处理
- ✅ 详细的日志输出

**关键方法**：
- `_detectShowdownModule()` - 自动检测可用的模块
- `_requireShowdownModule()` - 智能加载模块（npm 包或本地路径）

### 2. BattleManager 使用适配层 ✅

**文件**：`poke-proxy-server/core/BattleManager.js`

**改进**：
- ✅ 移除了直接引用 `../../../pokemon-showdown`
- ✅ 统一使用 `showdownAdapter` 获取模块
- ✅ 支持 npm 包和本地路径两种方式

### 3. 自动安装脚本 ✅

**文件**：`poke-proxy-server/scripts/install-showdown.js`

**功能**：
- ✅ 检查 npm 包是否可用
- ✅ 检查本地路径是否存在
- ✅ 自动从 GitHub 克隆（如果需要）
- ✅ 自动构建（如果需要）

### 4. package.json 配置 ✅

**改进**：
- ✅ 添加 `postinstall` 脚本，自动执行安装
- ✅ 添加 `@pkmn/sim` 依赖（可选，作为首选）

---

## 📦 推荐的三种方案

### 方案 1：使用 GitHub 依赖（最简单，推荐）⭐

在 `poke-proxy-server/package.json` 中添加：

```json
{
  "dependencies": {
    "pokemon-showdown": "https://github.com/smogon/pokemon-showdown.git#master"
  }
}
```

**优点**：
- ✅ 一行配置即可
- ✅ npm 自动处理
- ✅ 版本锁定

**缺点**：
- ⚠️ 需要 Git（npm 会自动处理）
- ⚠️ 首次安装需要下载完整仓库

### 方案 2：使用自动安装脚本（已实现）⭐

使用已创建的 `install-showdown.js` 脚本。

**优点**：
- ✅ 完全自动化
- ✅ 向后兼容
- ✅ 可配置版本

**缺点**：
- ⚠️ 需要 Git 命令
- ⚠️ 需要网络连接

### 方案 3：使用 @pkmn/sim（如果兼容）⭐

在 `package.json` 中添加：

```json
{
  "dependencies": {
    "@pkmn/sim": "^0.5.3"
  }
}
```

**优点**：
- ✅ 标准 npm 包
- ✅ 体积较小

**缺点**：
- ⚠️ 需要验证 API 兼容性
- ⚠️ 可能需要适配代码

---

## 🚀 推荐实现：方案 1（GitHub 依赖）

### 修改 package.json

```json
{
  "dependencies": {
    "pokemon-showdown": "https://github.com/smogon/pokemon-showdown.git#master",
    // 或指定版本标签
    // "pokemon-showdown": "https://github.com/smogon/pokemon-showdown.git#v1.2.3",
    // ... 其他依赖
  }
}
```

### 自动构建（可选）

Pokemon Showdown 可能需要构建。可以在 `postinstall` 脚本中添加：

```json
{
  "scripts": {
    "postinstall": "node scripts/install-showdown.js && node scripts/build-showdown.js"
  }
}
```

---

## 📝 用户使用流程（改造后）

### 步骤 1：解压项目

```bash
unzip pokemmo-myself.zip
cd "pokemmo myself"
```

### 步骤 2：安装依赖

```bash
# 根目录
npm install

# 后端目录（会自动安装 pokemon-showdown）
cd poke-proxy-server
npm install
```

**自动执行**：
- ✅ npm 自动从 GitHub 下载 pokemon-showdown
- ✅ 自动运行 postinstall 脚本（如果需要构建）

### 步骤 3：启动服务

```bash
# 终端1：启动后端
cd poke-proxy-server
node battle-server.js

# 终端2：启动前端
cd ..
node simple-http-server.js 8080
```

### 步骤 4：打开浏览器

```
http://localhost:8080/pokemmo.html
```

---

## ⚠️ 注意事项

### 1. 首次安装时间

- 下载 pokemon-showdown 可能需要 1-5 分钟（取决于网络）
- 如果需要构建，额外增加 2-5 分钟

### 2. 网络要求

- ✅ npm install 需要网络（下载依赖）
- ✅ 如果使用 GitHub 依赖，需要访问 GitHub
- ✅ 如果使用自动安装脚本，需要 Git 命令

### 3. 离线环境

如果需要在完全离线的环境中运行：
- 方案 A：压缩包中包含 `node_modules/pokemon-showdown`
- 方案 B：压缩包中包含 `pokemon-showdown` 目录
- 方案 C：使用本地 npm registry

---

## 🔍 验证方案

改造完成后，验证步骤：

```bash
# 1. 清理环境（模拟新用户）
rm -rf node_modules
rm -rf poke-proxy-server/node_modules
rm -rf pokemon-showdown  # 如果存在

# 2. 重新安装
npm install
cd poke-proxy-server && npm install

# 3. 验证 Pokemon Showdown 是否可用
node -e "const adapter = require('./adapters/pokemon-showdown/ShowdownAdapter'); console.log('Dex:', !!adapter.getDex());"

# 4. 启动服务器
node battle-server.js
# 应该能看到：✅ 检测到 npm 包 或 ✅ 本地路径已存在
```

---

## 📚 总结

### 改造前

用户需要：
1. 解压项目
2. 手动准备 `pokemon-showdown` 目录
3. 确保路径正确
4. 安装依赖
5. 启动服务

### 改造后

用户只需：
1. 解压项目
2. 运行 `npm install`（2个目录）
3. 启动服务

**完全自动化，零配置！** 🎉


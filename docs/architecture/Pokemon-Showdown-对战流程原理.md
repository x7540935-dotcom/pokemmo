# Pokemon Showdown å¯¹æˆ˜æ¨¡å—æ§åˆ¶æµç¨‹åŸç†è¯¦è§£

> æœ¬æ–‡æ¡£æ·±å…¥è§£æ Pokemon Showdown å¯¹æˆ˜å¼•æ“ï¼ˆBattleStreamï¼‰çš„å·¥ä½œåŸç†ï¼Œå¸®åŠ©ç†è§£å¯¹æˆ˜æµç¨‹æ˜¯å¦‚ä½•è¢«æ§åˆ¶çš„ã€‚

---

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
2. [BattleStream æ¶æ„](#battlestream-æ¶æ„)
3. [åè®®æµåˆ†ç¦»æœºåˆ¶](#åè®®æµåˆ†ç¦»æœºåˆ¶)
4. [å¯¹æˆ˜åˆå§‹åŒ–æµç¨‹](#å¯¹æˆ˜åˆå§‹åŒ–æµç¨‹)
5. [å›åˆåˆ¶æ§åˆ¶æœºåˆ¶](#å›åˆåˆ¶æ§åˆ¶æœºåˆ¶)
6. [é€‰æ‹©å¤„ç†æµç¨‹](#é€‰æ‹©å¤„ç†æµç¨‹)
7. [åè®®ç”Ÿæˆä¸åˆ†å‘](#åè®®ç”Ÿæˆä¸åˆ†å‘)
8. [å®é™…å·¥ä½œæµç¨‹å›¾](#å®é™…å·¥ä½œæµç¨‹å›¾)

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### BattleStream

`BattleStream` æ˜¯ Pokemon Showdown çš„æ ¸å¿ƒå¯¹æˆ˜å¼•æ“ï¼Œå®ƒæ˜¯ä¸€ä¸ª**åŒå‘æµï¼ˆDuplex Streamï¼‰**ï¼š

- **è¾“å…¥ï¼ˆå†™å…¥ï¼‰**ï¼šæ¥æ”¶ç©å®¶å‘½ä»¤ï¼ˆå¦‚ `>start`, `>player`, `>move`, `>switch`ï¼‰
- **è¾“å‡ºï¼ˆè¯»å–ï¼‰**ï¼šç”Ÿæˆå¯¹æˆ˜åè®®ï¼ˆå¦‚ `|request|`, `|switch|`, `|move|`, `|-damage|`ï¼‰

### åè®®æµåˆ†ç¦»

`getPlayerStreams(battleStream)` å°†ä¸€ä¸ª BattleStream åˆ†è§£ä¸ºä¸‰ä¸ªç‹¬ç«‹çš„æµï¼š

1. **omniscientï¼ˆå…¨çŸ¥æµï¼‰**ï¼šæ‰€æœ‰ç©å®¶éƒ½èƒ½çœ‹åˆ°çš„åè®®
2. **p1 æµ**ï¼šåªå‘é€ç»™ç©å®¶ 1 çš„åè®®
3. **p2 æµ**ï¼šåªå‘é€ç»™ç©å®¶ 2 çš„åè®®

è¿™ç§åˆ†ç¦»æœºåˆ¶ç¡®ä¿äº†ï¼š
- æ¯ä¸ªç©å®¶åªèƒ½çœ‹åˆ°è‡ªå·±åº”è¯¥çœ‹åˆ°çš„ä¿¡æ¯
- æœåŠ¡å™¨å¯ä»¥æ§åˆ¶ä¿¡æ¯çš„åˆ†å‘
- æ”¯æŒè§‚æˆ˜æ¨¡å¼ï¼ˆåªéœ€è¦è®¢é˜… omniscient æµï¼‰

---

## ğŸ—ï¸ BattleStream æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BattleStream (æ ¸å¿ƒå¼•æ“)                â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          è¾“å…¥æµ (Write)                      â”‚  â”‚
â”‚  â”‚  >start {...}                                â”‚  â”‚
â”‚  â”‚  >player p1 {...}                            â”‚  â”‚
â”‚  â”‚  >player p2 {...}                            â”‚  â”‚
â”‚  â”‚  >p1 move 1                                  â”‚  â”‚
â”‚  â”‚  >p2 switch 2                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â†“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        å¯¹æˆ˜é€»è¾‘å¤„ç† (Battle Class)           â”‚  â”‚
â”‚  â”‚  - å›åˆåˆ¶çŠ¶æ€æœº                               â”‚  â”‚
â”‚  â”‚  - æŠ€èƒ½æ•ˆæœè®¡ç®—                               â”‚  â”‚
â”‚  â”‚  - ä¼¤å®³è®¡ç®—                                   â”‚  â”‚
â”‚  â”‚  - çŠ¶æ€æ•ˆæœå¤„ç†                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â†“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          è¾“å‡ºæµ (Read)                       â”‚  â”‚
â”‚  â”‚  |request|{...}  â†’ å‘é€åˆ° p1 æµ              â”‚  â”‚
â”‚  â”‚  |request|{...}  â†’ å‘é€åˆ° p2 æµ              â”‚  â”‚
â”‚  â”‚  |switch|...     â†’ å‘é€åˆ° omniscient æµ      â”‚  â”‚
â”‚  â”‚  |move|...       â†’ å‘é€åˆ° omniscient æµ      â”‚  â”‚
â”‚  â”‚  |-damage|...    â†’ å‘é€åˆ° omniscient æµ      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                    â†“                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚omniscientâ”‚        â”‚  p1 æµ â”‚          â”‚  p2 æµ â”‚
    â”‚   æµ    â”‚        â”‚        â”‚          â”‚        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ åè®®æµåˆ†ç¦»æœºåˆ¶

### åè®®ç±»å‹åˆ†ç±»

#### 1. Omniscient æµï¼ˆå…¬å…±åè®®ï¼‰

æ‰€æœ‰ç©å®¶éƒ½èƒ½çœ‹åˆ°çš„åè®®ï¼ŒåŒ…æ‹¬ï¼š

```javascript
|poke|p1: Pikachu       // é˜Ÿä¼ä¿¡æ¯
|switch|p1a: Pikachu    // å®å¯æ¢¦åˆ‡æ¢
|move|p1a: Pikachu|Thunderbolt|p2a: Pikachu  // æŠ€èƒ½ä½¿ç”¨
|-damage|p2a: Pikachu|100/100|0 fnt  // ä¼¤å®³
|faint|p2a: Pikachu     // å®å¯æ¢¦å€’ä¸‹
|win|Player 1           // å¯¹æˆ˜ç»“æŸ
|turn|1                 // å›åˆæ•°
```

#### 2. p1/p2 æµï¼ˆä¸“å±åè®®ï¼‰

åªå‘é€ç»™å¯¹åº”ç©å®¶çš„åè®®ï¼Œä¸»è¦æ˜¯ï¼š

```javascript
|request|{
  "side": {
    "id": "p1",
    "pokemon": [...],
    ...
  },
  "active": [...],
  "wait": false,
  "forceSwitch": false,
  ...
}
```

### æµåˆ†ç¦»çš„å®ç°

```javascript
// 1. åˆ›å»º BattleStream
const battleStream = new BattleStream();

// 2. åˆ†ç¦»å‡ºä¸‰ä¸ªæµ
const streams = getPlayerStreams(battleStream);

// 3. ä¸‰ä¸ªæµæ˜¯ç‹¬ç«‹çš„å¼‚æ­¥è¿­ä»£å™¨
// streams.omniscient - å…¬å…±åè®®æµ
// streams.p1 - p1 ä¸“å±åè®®æµ
// streams.p2 - p2 ä¸“å±åè®®æµ

// 4. ç›‘å¬åè®®æµ
(async () => {
  for await (const chunk of streams.omniscient) {
    // å¤„ç†å…¬å…±åè®®
    broadcast(chunk.toString());
  }
})();

(async () => {
  for await (const chunk of streams.p1) {
    // å¤„ç† p1 ä¸“å±åè®®
    sendToPlayer1(chunk.toString());
  }
})();
```

---

## ğŸš€ å¯¹æˆ˜åˆå§‹åŒ–æµç¨‹

### 1. åˆ›å»º BattleStream

```javascript
const { BattleStream, getPlayerStreams } = require('pokemon-showdown/sim');
const battleStream = new BattleStream();
const streams = getPlayerStreams(battleStream);
```

### 2. å¯åŠ¨åè®®ç›‘å¬å™¨

**å…³é”®ï¼šå¿…é¡»å…ˆå¯åŠ¨ç›‘å¬å™¨ï¼Œå†å‘é€åˆå§‹åŒ–å‘½ä»¤ï¼**

```javascript
// å…ˆå¯åŠ¨ç›‘å¬å™¨ï¼ˆå¼‚æ­¥ï¼‰
startStreamListeners();

// ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿ç›‘å¬å™¨å·²å¯åŠ¨
await new Promise(resolve => setTimeout(resolve, 10));
```

### 3. å‘é€åˆå§‹åŒ–å‘½ä»¤

```javascript
const initCommand = `>start ${JSON.stringify({formatid: 'gen9ou', seed: null})}
>player p1 ${JSON.stringify({name: 'Player 1', team: p1Team})}
>player p2 ${JSON.stringify({name: 'Player 2', team: p2Team})}`;

battleStream.write(initCommand);
```

### 4. BattleStream å¤„ç†æµç¨‹

```
å†™å…¥å‘½ä»¤ â†’ BattleStream è§£æ â†’ åˆ›å»º Battle å®ä¾‹ â†’ ç”Ÿæˆåˆå§‹åè®®
```

**å‘½ä»¤è§£æ**ï¼š
- `>start {...}` â†’ åˆ›å»ºå¯¹æˆ˜å®ä¾‹ï¼Œè®¾ç½®æ ¼å¼å’Œéšæœºç§å­
- `>player p1 {...}` â†’ è®¾ç½®ç©å®¶ 1 çš„é˜Ÿä¼æ•°æ®
- `>player p2 {...}` â†’ è®¾ç½®ç©å®¶ 2 çš„é˜Ÿä¼æ•°æ®

**åè®®ç”Ÿæˆ**ï¼š
- ç”Ÿæˆ `|poke|` åè®®ï¼ˆé˜Ÿä¼ä¿¡æ¯ï¼‰â†’ omniscient æµ
- ç”Ÿæˆ `|request|` åè®®ï¼ˆé¦–å‘é€‰æ‹©è¯·æ±‚ï¼‰â†’ p1/p2 æµ
- ç”Ÿæˆ `|start|` åè®®ï¼ˆå¯¹æˆ˜å¼€å§‹ï¼‰â†’ omniscient æµ

---

## â±ï¸ å›åˆåˆ¶æ§åˆ¶æœºåˆ¶

### å›åˆçŠ¶æ€æœº

Pokemon Showdown å†…éƒ¨ä½¿ç”¨çŠ¶æ€æœºæ§åˆ¶å›åˆæµç¨‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆå§‹åŒ–çŠ¶æ€   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ æ”¶åˆ°åŒæ–¹é˜Ÿä¼
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜Ÿä¼é¢„è§ˆçŠ¶æ€  â”‚ â† |request| {"teamPreview": true}
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ åŒæ–¹é€‰æ‹©é¦–å‘
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å›åˆå¼€å§‹çŠ¶æ€  â”‚ â† |turn| 1
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   â”‚ ç­‰å¾…é€‰æ‹©çŠ¶æ€  â”‚ â† |request| {...}
       â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚          â”‚ æ”¶åˆ°åŒæ–¹é€‰æ‹©
       â”‚          â–¼
       â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   â”‚ æ‰§è¡Œå›åˆçŠ¶æ€  â”‚
       â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚          â”‚ ç”Ÿæˆåè®®
       â”‚          â–¼
       â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   â”‚ å›åˆç»“æŸçŠ¶æ€  â”‚
       â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚          â”‚
       â”‚          â”œâ”€â†’ å¯¹æˆ˜ç»§ç»­ â†’ ç­‰å¾…é€‰æ‹©çŠ¶æ€
       â”‚          â”‚
       â”‚          â””â”€â†’ å¯¹æˆ˜ç»“æŸ â†’ ç»“æŸçŠ¶æ€
       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  ç»“æŸçŠ¶æ€     â”‚ â† |win| Player 1
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### request åè®®çš„å…³é”®å­—æ®µ

```javascript
{
  "side": {
    "id": "p1",
    "pokemon": [...],  // é˜Ÿä¼ä¿¡æ¯
    ...
  },
  "active": [{
    "moves": [...],    // å¯ç”¨æŠ€èƒ½
    ...
  }],
  "wait": false,       // âš ï¸ å…³é”®ï¼šæ˜¯å¦éœ€è¦ç­‰å¾…å¯¹æ‰‹
  "forceSwitch": false, // æ˜¯å¦å¼ºåˆ¶æ¢äºº
  "teamPreview": false  // æ˜¯å¦æ˜¯é˜Ÿä¼é¢„è§ˆ
}
```

**`wait` å­—æ®µçš„ä½œç”¨**ï¼š
- `wait: false` â†’ åŒæ–¹éƒ½å¯ä»¥é€‰æ‹©ï¼Œå…ˆé€‰å®Œçš„ç­‰å¾…
- `wait: true` â†’ å½“å‰ç©å®¶å¿…é¡»ç­‰å¾…å¯¹æ‰‹å…ˆé€‰æ‹©

### å›åˆåŒæ­¥æœºåˆ¶

```javascript
// å›åˆå¼€å§‹ï¼ŒåŒæ–¹éƒ½æ”¶åˆ° request
|request|{...}  // å‘é€ç»™ p1ï¼ˆwait: falseï¼‰
|request|{...}  // å‘é€ç»™ p2ï¼ˆwait: falseï¼‰

// p1 é€‰æ‹©å®Œæˆ
>p1 move 1

// p2 æ”¶åˆ°æ–°çš„ requestï¼ˆwait: trueï¼Œç­‰å¾… p1 çš„ç¡®è®¤ï¼‰
|request|{...}  // wait: true

// p2 é€‰æ‹©å®Œæˆ
>p2 switch 2

// åŒæ–¹éƒ½é€‰æ‹©å®Œæˆï¼Œæ‰§è¡Œå›åˆ
|turn|1
|move|p1a: Pikachu|Thunderbolt|p2a: Pikachu
|-damage|p2a: Pikachu|100/100|0 fnt
|faint|p2a: Pikachu

// å¦‚æœ p2 éœ€è¦æ¢äººï¼Œå‘é€æ–°çš„ request
|request|{...}  // forceSwitch: true
```

---

## ğŸ® é€‰æ‹©å¤„ç†æµç¨‹

### ç©å®¶é€‰æ‹©å‘½ä»¤æ ¼å¼

```javascript
// ä½¿ç”¨æŠ€èƒ½
>p1 move 1              // ä½¿ç”¨ç¬¬ 1 ä¸ªæŠ€èƒ½
>p2 move 2              // ä½¿ç”¨ç¬¬ 2 ä¸ªæŠ€èƒ½

// æ¢äºº
>p1 switch 2            // åˆ‡æ¢åˆ°é˜Ÿä¼ä¸­çš„ç¬¬ 2 åªå®å¯æ¢¦ï¼ˆç´¢å¼•ä» 1 å¼€å§‹ï¼‰
>p2 switch 3

// é˜Ÿä¼é¢„è§ˆé€‰æ‹©é¦–å‘
>p1 team 1,2            // é€‰æ‹©ç¬¬ 1ã€2 åªå®å¯æ¢¦é¦–å‘ï¼ˆå¦‚æœæ˜¯åŒæ‰“ï¼‰
>p2 team 1
```

### å‘½ä»¤å¤„ç†æµç¨‹

```
ç©å®¶å‘é€å‘½ä»¤ â†’ BattleStream.write() â†’ è§£æå‘½ä»¤ç±»å‹
                                      â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                   â”‚
              >p1 move 1                        >p2 switch 2
                    â”‚                                   â”‚
                    â–¼                                   â–¼
           æŠ€èƒ½éªŒè¯ä¸æ‰§è¡Œ                          æ¢äººéªŒè¯ä¸æ‰§è¡Œ
                    â”‚                                   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
                           ç”Ÿæˆæ‰§è¡Œç»“æœåè®®
                                      â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                   â”‚
              omniscient æµ                       æ–°çš„ request
            (|move|, |-damage|)                 (å¦‚æœéœ€è¦ä¸‹ä¸€å›åˆ)
```

### å‘½ä»¤éªŒè¯

BattleStream ä¼šéªŒè¯ï¼š
- âœ… å‘½ä»¤æ ¼å¼æ˜¯å¦æ­£ç¡®
- âœ… é€‰æ‹©çš„æŠ€èƒ½/å®å¯æ¢¦æ˜¯å¦å¯ç”¨
- âœ… æ˜¯å¦ç¬¦åˆå½“å‰çŠ¶æ€ï¼ˆå¦‚æ˜¯å¦å¼ºåˆ¶æ¢äººï¼‰
- âœ… å›åˆæ˜¯å¦å…è®¸æ­¤æ“ä½œ

å¦‚æœéªŒè¯å¤±è´¥ï¼Œä¼šç”Ÿæˆé”™è¯¯åè®®ï¼š
```javascript
|error|[Invalid choice] ...
```

---

## ğŸ“¡ åè®®ç”Ÿæˆä¸åˆ†å‘

### åè®®ç”Ÿæˆæ—¶æœº

åè®®æ˜¯åœ¨å¯¹æˆ˜çŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨ç”Ÿæˆçš„ï¼š

1. **åˆå§‹åŒ–æ—¶**ï¼š
   - `|poke|` - é˜Ÿä¼ä¿¡æ¯
   - `|start|` - å¯¹æˆ˜å¼€å§‹
   - `|request|` - è¯·æ±‚é€‰æ‹©

2. **å›åˆæ‰§è¡Œæ—¶**ï¼š
   - `|turn|` - å›åˆæ•°
   - `|move|` - æŠ€èƒ½ä½¿ç”¨
   - `|-damage|` - ä¼¤å®³æ˜¾ç¤º
   - `|-status|` - çŠ¶æ€å˜åŒ–
   - `|faint|` - å®å¯æ¢¦å€’ä¸‹

3. **å›åˆç»“æŸæ—¶**ï¼š
   - `|request|` - è¯·æ±‚ä¸‹ä¸€å›åˆçš„é€‰æ‹©
   - æˆ– `|win|` - å¯¹æˆ˜ç»“æŸ

### åè®®åˆ†å‘é€»è¾‘

```javascript
// BattleStream å†…éƒ¨é€»è¾‘ï¼ˆä¼ªä»£ç ï¼‰
function processAction(action) {
  // 1. æ‰§è¡ŒåŠ¨ä½œ
  const result = battle.executeAction(action);
  
  // 2. ç”Ÿæˆåè®®
  const protocols = battle.generateProtocols(result);
  
  // 3. åˆ†å‘åè®®
  for (const protocol of protocols) {
    if (protocol.type === 'request') {
      // request åè®®æ ¹æ® side å‘é€åˆ°å¯¹åº”çš„ç©å®¶æµ
      if (protocol.side === 'p1') {
        streams.p1.write(protocol);
      } else {
        streams.p2.write(protocol);
      }
    } else {
      // å…¶ä»–åè®®å‘é€åˆ° omniscient æµ
      streams.omniscient.write(protocol);
    }
  }
}
```

---

## ğŸ”„ å®é™…å·¥ä½œæµç¨‹å›¾

### å®Œæ•´å¯¹æˆ˜æµç¨‹ç¤ºä¾‹

```
ã€é˜¶æ®µ 1ï¼šåˆå§‹åŒ–ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åˆ›å»º BattleStream                         â”‚
â”‚ 2. åˆ†ç¦»æµï¼ˆomniscient, p1, p2ï¼‰              â”‚
â”‚ 3. å¯åŠ¨åè®®ç›‘å¬å™¨                            â”‚
â”‚ 4. å†™å…¥åˆå§‹åŒ–å‘½ä»¤ï¼š                          â”‚
â”‚    >start {...}                              â”‚
â”‚    >player p1 {...}                          â”‚
â”‚    >player p2 {...}                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BattleStream å¤„ç†ï¼š                          â”‚
â”‚ - åˆ›å»º Battle å®ä¾‹                           â”‚
â”‚ - åŠ è½½é˜Ÿä¼æ•°æ®                               â”‚
â”‚ - ç”Ÿæˆåˆå§‹åè®®                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åè®®è¾“å‡ºï¼š                                   â”‚
â”‚ omniscient: |poke|...                       â”‚
â”‚ omniscient: |start|...                      â”‚
â”‚ p1: |request|{"teamPreview": true}          â”‚
â”‚ p2: |request|{"teamPreview": true}          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€é˜¶æ®µ 2ï¼šé˜Ÿä¼é¢„è§ˆã€‘
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ p1 é€‰æ‹©ï¼š>p1 team 1                         â”‚
â”‚ p2 é€‰æ‹©ï¼š>p2 team 1                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BattleStream å¤„ç†ï¼š                          â”‚
â”‚ - éªŒè¯é€‰æ‹©                                   â”‚
â”‚ - è®¾ç½®é¦–å‘                                   â”‚
â”‚ - è¿›å…¥ç¬¬ä¸€å›åˆ                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åè®®è¾“å‡ºï¼š                                   â”‚
â”‚ omniscient: |switch|p1a: Pikachu|...       â”‚
â”‚ omniscient: |switch|p2a: Pikachu|...       â”‚
â”‚ omniscient: |turn|1                         â”‚
â”‚ p1: |request|{...}                          â”‚
â”‚ p2: |request|{...}                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€é˜¶æ®µ 3ï¼šå›åˆå¾ªç¯ã€‘
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ p1 é€‰æ‹©ï¼š>p1 move 1                         â”‚
â”‚ p2 é€‰æ‹©ï¼š>p2 move 2                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BattleStream å¤„ç†ï¼š                          â”‚
â”‚ - éªŒè¯é€‰æ‹©                                   â”‚
â”‚ - è®¡ç®—é€Ÿåº¦ä¼˜å…ˆçº§                             â”‚
â”‚ - æ‰§è¡ŒæŠ€èƒ½æ•ˆæœ                               â”‚
â”‚ - è®¡ç®—ä¼¤å®³                                   â”‚
â”‚ - å¤„ç†çŠ¶æ€æ•ˆæœ                               â”‚
â”‚ - æ£€æŸ¥å¯¹æˆ˜æ˜¯å¦ç»“æŸ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åè®®è¾“å‡ºï¼š                                   â”‚
â”‚ omniscient: |move|p1a: Pikachu|Thunderbolt â”‚
â”‚ omniscient: |-damage|p2a: Pikachu|80/100   â”‚
â”‚ omniscient: |move|p2a: Pikachu|Thunderbolt â”‚
â”‚ omniscient: |-damage|p1a: Pikachu|75/100   â”‚
â”‚ omniscient: |turn|2                         â”‚
â”‚ p1: |request|{...}  // å¦‚æœéœ€è¦ä¸‹ä¸€å›åˆ     â”‚
â”‚ p2: |request|{...}  // å¦‚æœéœ€è¦ä¸‹ä¸€å›åˆ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€é˜¶æ®µ 4ï¼šå¯¹æˆ˜ç»“æŸã€‘
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æµ‹åˆ°ä¸€æ–¹é˜Ÿä¼å…¨éƒ¨å€’ä¸‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BattleStream å¤„ç†ï¼š                          â”‚
â”‚ - æ ‡è®°å¯¹æˆ˜ç»“æŸ                               â”‚
â”‚ - ç”Ÿæˆç»“æŸåè®®                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åè®®è¾“å‡ºï¼š                                   â”‚
â”‚ omniscient: |faint|p2a: Pikachu            â”‚
â”‚ omniscient: |win|Player 1                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ å…³é”®è¦ç‚¹æ€»ç»“

### 1. æµå¼å¤„ç†

BattleStream ä½¿ç”¨**æµå¼å¤„ç†**æœºåˆ¶ï¼š
- å‘½ä»¤é€šè¿‡ `write()` å¼‚æ­¥å†™å…¥
- åè®®é€šè¿‡å¼‚æ­¥è¿­ä»£å™¨å¼‚æ­¥è¯»å–
- ä¸éœ€è¦ç­‰å¾…æ•´ä¸ªå¯¹æˆ˜å®Œæˆï¼Œå¯ä»¥å®æ—¶å¤„ç†

### 2. åè®®åˆ†ç¦»

ä¸‰ä¸ªæµçš„åˆ†ç¦»ç¡®ä¿äº†ï¼š
- **å®‰å…¨æ€§**ï¼šç©å®¶çœ‹ä¸åˆ°å¯¹æ‰‹çš„ç§æœ‰ä¿¡æ¯
- **çµæ´»æ€§**ï¼šå¯ä»¥ç‹¬ç«‹æ§åˆ¶æ¯ä¸ªç©å®¶çš„åè®®
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒè§‚æˆ˜ã€å›æ”¾ç­‰åŠŸèƒ½

### 3. çŠ¶æ€é©±åŠ¨

å¯¹æˆ˜æµç¨‹ç”±**å†…éƒ¨çŠ¶æ€æœº**æ§åˆ¶ï¼š
- çŠ¶æ€å†³å®šä½•æ—¶è¯·æ±‚ç©å®¶é€‰æ‹©
- çŠ¶æ€å†³å®šä½•æ—¶æ‰§è¡Œå›åˆ
- çŠ¶æ€å†³å®šä½•æ—¶ç»“æŸå¯¹æˆ˜

### 4. å›åˆåŒæ­¥

é€šè¿‡ `request.wait` å­—æ®µå®ç°å›åˆåŒæ­¥ï¼š
- ç¡®ä¿åŒæ–¹éƒ½é€‰æ‹©åå†æ‰§è¡Œå›åˆ
- æ”¯æŒç‰¹æ®Šæœºåˆ¶ï¼ˆå¦‚è“„åŠ›æŠ€èƒ½ï¼‰

### 5. å‘½ä»¤éªŒè¯

BattleStream ä¼šè‡ªåŠ¨éªŒè¯å‘½ä»¤ï¼š
- é˜²æ­¢æ— æ•ˆæ“ä½œ
- ç¡®ä¿å¯¹æˆ˜è§„åˆ™çš„æ­£ç¡®æ‰§è¡Œ
- ç”Ÿæˆé”™è¯¯æç¤º

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Pokemon Showdown å®˜æ–¹æ–‡æ¡£](https://github.com/smogon/pokemon-showdown)
- [BattleStream æºç ](https://github.com/smogon/pokemon-showdown/blob/master/sim/battle-stream.ts)
- é¡¹ç›®ä¸­çš„å®é™…å®ç°ï¼š
  - `pokemmo myself/poke-proxy-server/core/BattleManager.js`
  - `pokemmo myself/poke-proxy-server/domain/battles/SimplePvPManager.js`

---

**æœ€åæ›´æ–°**ï¼š2025-01-24


# 前端模块说明（重构版）

> 适用目录：`pokemmo myself/packages/battle-engine/src`  
> 更新时间：2025-11-18

---

## 1. 模块全景
```
packages/battle-engine/src/
├─ core/
│  ├─ BattleEngine.js
│  ├─ ProtocolParser.js
│  └─ StateManager.js
├─ phases/
│  ├─ PhaseBase.js
│  ├─ TeamLoadingPhase.js
│  ├─ TeamPreviewPhase.js
│  ├─ PokemonDataPhase.js
│  └─ BattlePhase.js
├─ state-machine/
│  └─ BattleStateMachine.js
├─ ui/
│  └─ BattleUI.js
└─ utils/
   ├─ Localization.js
   ├─ SpriteLoader.js
   ├─ PokemonUtils.js
   ├─ Logger.js
   ├─ PerformanceMonitor.js
   ├─ PerformanceReporter.js
   └─ WebVitalsReporter.js
```

### 1.1 拆分路线（已完成第一阶段）
| 子包 | 职责 | 备注 |
| ---- | ---- | ---- |
| `connection` | WebSocket、心跳、重连、诊断 | 从 BattleEngine 中抽离 |
| `protocol` | Pokemon Showdown 协议解析/路由 | 与后端保持一致，便于测试 |
| `state` | 状态机、Phase、StateManager | 输出纯逻辑，可供多终端复用 |
| `ui` | 渲染器、皮肤、交互适配层 | 计划支持多主题 |
| `localization` | 翻译、资源 manifest | 与数据流水线联动 |
| `observability` | Web Vitals + 自定义性能埋点 | 与后台 `/api/metrics` 协议一致 |

---

## 2. BattleEngine（待拆分）

| 能力 | 现状 | 重构动作 |
| ---- | ---- | ---- |
| 连接 | `connect / send / disconnect` 内含大量日志 | 抽离为 `ConnectionClient`，提供事件流 |
| 协议 | `processMessage` 同时处理 JSON / PS 协议 | 迁移至 `ProtocolChannel`，可挂插件 |
| 日志 | 直接写 `console.log`、`window.protocolLogs` | 统一接入 `Logger` & devtools |
| 回调 | 基于数组存储回调 | 使用 Typed EventEmitter |

### 2.1 目标接口
```ts
const client = new ConnectionClient({ url });
client.events.on('message', ProtocolChannel.handle);
client.events.on('diagnostics', Diagnostics.report);
client.send(Command.start(payload));
```

---

## 3. ProtocolParser
- 解析 Pokemon Showdown 文本协议，输出 `{ type, payload }`
- 识别关键协议：`request / teampreview / poke / switch / start / win`
- 提供 `registerHandler(type, fn)` 钩子，用于指标、日志、调试
- 支持 JSON 控制消息（room-created、battle-reconnected 等）

> 重构目标：纯函数 + 可注入上下文，便于单测与重放。

---

## 4. StateManager

| 分区 | 说明 |
| ---- | ---- |
| connection | readyState、心跳、重连次数 |
| battle | 阶段、当前请求、回合数、log |
| teams | 玩家/对手队伍、active、墓地 |
| ui | 选中技能、禁用按钮、提示状态 |

### 4.1 API
```ts
state.initialize();
state.updateTeam('player', team);
state.setRequest(request);
state.appendProtocol(protocol);
state.snapshot(); // 用于 UI 渲染/回放
```

> 计划引入不可变状态（immer）与订阅接口（observer pattern）。

---

## 5. 状态机与阶段

### 5.1 BattleStateMachine
- 管理 Phase 注册与切换
- 接收两类事件：`handleProtocol`、`handleUserAction`
- 支持 `transitionTo(name, data)`、`resumeFrom(snapshot)`

### 5.2 Phase 约定
```ts
class PhaseBase {
  enter(context) {}
  exit() {}
  handleProtocol(protocol) {}
  handleUserAction(action) {}
}
```

| Phase | 触发协议 | 职责 |
| ----- | -------- | ---- |
| TeamLoading | `start` 前 | 读取队伍、连接 WS、发送 start |
| TeamPreview | `teampreview` / `request` | 展示阵容、首发选择 |
| PokemonData | 初次 `poke/switch` | 同步宝可梦详情与 UI |
| Battle | 常规协议 | 渲染技能、换人、胜负、日志 |

> 后续为每个 Phase 提供独立测试及事件快照。

---

## 6. UI 层

### 6.1 BattleUI
- 渲染技能按钮、换人面板、HP/状态、战斗日志
- 向状态机发送用户操作事件
- 接受状态快照，按需局部刷新

### 6.2 皮肤与扩展
- 计划提供 `renderers/`：`classic`（当前）、`minimal`、`stream`
- 每个 renderer 只依赖状态快照和事件派发器

---

## 7. 工具模块

| 模块 | 功能 | 备注 |
| ---- | ---- | ---- |
| Localization | 翻译加载、缓存、fallback | 未来改为异步 + manifest |
| SpriteLoader | Sprites URL 生成、优先级控制 | 将与资源流水线共享数据 |
| PokemonUtils | 名称解析、合法性检查 | 计划迁至 shared 包 |
| Logger | 日志级别、时间戳、模块前缀 | 与后端 Logger 对齐 |
| MoveDataHelper | 技能辅助（若使用） | 考虑合并入 protocol 层 |
| PerformanceMonitor | Web Vitals + 自定义指标采集 | 通过事件上报给 Reporter |
| PerformanceReporter | 批量上报性能数据、离线缓存 | POST `/api/metrics`，支持重试 |
| WebVitalsReporter | 轻量封装 web-vitals | 自动调用 PerformanceReporter |

---

## 8. 数据与资源
1. `data/chinese/*.json`：翻译数据
2. `cache/sprites/`：本地贴图缓存
3. `missing-sprites.json`：缺失记录

重构后会新增：
- `data/manifest/localization.json`
- `data/manifest/sprites.json`

---

## 9. 前端重构任务
| 编号 | 任务 | 成果 |
| ---- | ---- | ---- |
| FE-01 | BattleEngine 拆分 | `connection + protocol + diagnostics` |
| FE-02 | 建立 Vite 多入口 | 产出 `apps/*` 可用 bundle |
| FE-03 | 状态不可变化 + 单测 | Phase/StateManager 拥有快照测试 |
| FE-04 | UI renderer 插件化 | BattleUI 变为可替换实现 |
| FE-05 | 资源 manifest pipeline | 构建期校验 sprites/localization |
| FE-06 | Web Vitals 接入 | PerformanceMonitor + Reporter + `/api/metrics` |
| FE-07 | UI 性能埋点 | Transition/Render 时间写入自定义指标 |

更新模块请同步修改本文件并在路线图登记任务。***


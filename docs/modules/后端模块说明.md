# 后端模块说明（重构版）

> 适用目录：`pokemmo myself/poke-proxy-server`（未来将迁移为 `services/battle-server`）  
> 更新时间：2025-11-18

---

## 1. 目录结构（现状）
```
poke-proxy-server/
├─ battle-server.js
├─ config/
│  ├─ index.js
│  └─ schema.js
├─ server/
│  ├─ bootstrap.js
│  ├─ metricsEndpoint.js
│  ├─ metricsApiEndpoint.js
│  └─ healthEndpoint.js
├─ controllers/
│  ├─ connectionController.js
│  ├─ AIBattleController.js
│  └─ PvPController.js
├─ domain/
│  ├─ battles/
│  │  ├─ BattleManager.js
│  │  └─ SimplePvPManager.js
│  ├─ rooms/
│  │  ├─ Room.js
│  │  └─ RoomManager.js
│  └─ choices/
│     ├─ PlayerChoiceHandler.js
│     ├─ AIChoiceHandler.js
│     └─ ProtocolRouter.js
├─ core/
│  ├─ PvPHandler.js
│  ├─ WebSocketDiagnostics.js
│  └─ ai/ 以及 tools/*
└─ package.json
```

---

## 2. 重构目标结构
```
services/battle-server/
├─ server/            # HTTP/WS 启动、CORS、health check
├─ controllers/       # PvPController, AIBattleController, DiagnosticsController
├─ domain/
│  ├─ battles/
│  │  ├─ BattleManager.ts
│  │  ├─ SimplePvPManager.ts
│  │  └─ ChoiceHandlers/
│  ├─ rooms/
│  │  ├─ Room.ts
│  │  ├─ RoomManager.ts
│  │  └─ events.ts
│  └─ ai/
│     ├─ strategies (Simple/Medium/Advanced/Expert)
│     └─ services (RAG/LLM adapters)
├─ adapters/
│  ├─ pokemon-showdown/
│  ├─ rag/
│  ├─ resources/
│  ├─ logging/
│  └─ metrics/
├─ shared/
│  ├─ ConfigService.ts
│  ├─ Logger.ts
│  ├─ LogAggregator.ts
│  └─ errors.ts
└─ tests/
   ├─ unit/
   ├─ integration/
   └─ fixtures/
```

---

## 3. 核心模块说明

### 3.1 battle-server.js（入口）
- 创建 HTTP + WebSocket 服务器
- 通过 `config/` 读取端口、调试开关以及数据/贴图路径
- 注册 `connection` / `message` / `close`
- 区分 `start` / `choose` 消息，分别交给 PvP 或 AI 模式
- 直接调用 `generateRandomAITeam`、`BattleManager`、`PvPHandler`

> 下一步：继续拆分到 `server/bootstrap` 与 `controllers/*`，入口仅负责依赖注入。

### 3.2 BattleManager（`domain/battles/BattleManager.js`）
- 针对 **玩家 vs AI** 的 BattleStream 管理器
- 初始化 Pokemon Showdown `BattleStream`
- 监听 `omniscient/p1/p2` 三个流并路由协议
- 维护 `PlayerChoiceHandler`（p1）与 `AIChoiceHandler`（p2）
- 通过 `domain/choices/ProtocolRouter` 分发 request / switch / teampreview 协议
- 负责 AI 队伍生成、request 分发、胜负判定

### 3.3 SimplePvPManager（`domain/battles/SimplePvPManager.js`）
- 针对 **玩家 vs 玩家** 的 BattleStream 管理器
- 缓存每条协议，支持断线重连后补发
- 维护房间内两个玩家的队伍与连接
- 提供 `sendTo(side, protocol)`、`broadcast(protocol)` 等接口

### 3.4 RoomManager / Room（`domain/rooms/*`）
- 负责创建、查找、移除房间以及定时清理
- `Room` 记录：
  - 房主、加入者
  - WebSocket client
  - 队伍、准备状态
  - 对应的 `SimplePvPManager`
- 提供自动回收机制（超时、双方断线）

### 3.5 Handler 层
| 文件 | 位置 | 功能 |
| ---- | ---- | ---- |
| `PvPHandler` | `core/PvPHandler.js` | 处理房间创建/加入、ready、重连、消息透传 |
| `PlayerChoiceHandler` | `domain/choices/PlayerChoiceHandler.js` | 校验玩家提交的 `choose` 命令 |
| `AIChoiceHandler` | `domain/choices/AIChoiceHandler.js` | 根据难度选择 AI 策略，并生成命令 |
| `ProtocolRouter` | `domain/choices/ProtocolRouter.js` | 将 BattleStream 输出分发给 handler/缓存/日志 |
| `WebSocketDiagnostics` | `core/WebSocketDiagnostics.js` | 输出连接日志、事件、耗时 |

### 3.6 观测模块
| 组件 | 位置 | 说明 |
| ---- | ---- | ---- |
| PrometheusMetrics | `adapters/metrics/PrometheusMetrics.js` | 注册 Counter/Gauge/Histogram（WS、Battle、AI） |
| WebSocketMetrics | `adapters/metrics/WebSocketMetrics.js` | 包裹 `ws` 实例，采集连接/消息/错误 |
| Metrics Endpoint | `server/metricsEndpoint.js` | 暴露 `GET /metrics` |
| Performance API | `server/metricsApiEndpoint.js` | 接收前端性能上报，存储最近 N 条并可查询 |
| Health Endpoint | `server/healthEndpoint.js` | `/health`、`/health/live`、`/health/ready`、`/api/diagnostics` |
| Log Aggregator | `adapters/logging/LogAggregator.js` | 提供 in-memory 日志缓存 + stats |

---

## 4. AI 模块

| 模块 | 说明 |
| ---- | ---- |
| `SimpleAI` | 随机/基础克制规则，难度 1-2 |
| `MediumAI` | 属性克制 + HP 阶段，难度 3 |
| `AdvancedAI` | 引入场面评估、状态推理，难度 4 |
| `ExpertAI` | 通过 RAG/LLM 生成策略，难度 5 |
| `PromptBuilder` | 为 LLM 构造提示 |
| `RAGIntegration` | 访问本地知识库或外部服务 |
| `LLMClient` | 统一 API（可接 OpenAI、本地模型） |
| `TypeChartCalculator` | 属性克制表 |
| `DamageCalculator` | 粗略伤害估算 |
| `StrategyEvaluator` | 给定局面评分 |

> 重构计划：以 `Strategy` 接口形式对外暴露，方便新增策略或热插拔。

---

## 5. 配置与资源

| 主题 | 现状 | 重构 |
| ---- | ---- | ---- |
| 配置 | `.env` + `config/index.js`（已落地） | 已导出 schema，供健康端点与测试复用 |
| 中文数据 | `../data/chinese/*.json` 手动读取 | Manifest + 缓存层 |
| Sprites | `../cache/sprites` + `missing-sprites.json` | 资源服务 + CLI 校验 |
| 日志 | Logger + LogAggregator | 支持文件输出 / 诊断端点查询 |
| 指标 | Prometheus + Metrics API | `/metrics`、`/api/metrics` 已可供外部收集 |
| 健康/诊断 | /health /api/diagnostics | 统一输出服务状态、Metrics、日志统计 |

---

## 6. 数据流

### 6.1 AI 对战
```
start command → AIBattleController → BattleManager
BattleStream → ProtocolRouter → WebSocket (player)
request → PlayerChoiceHandler / AIChoiceHandler → BattleStream
win/faint → ProtocolRouter → 客户端
```

### 6.2 PvP 对战
```
Lobby 请求 → PvPController → RoomManager
双方 ready → SimplePvPManager 创建 BattleStream
协议流 → 缓存（omniscient/p1/p2）→ 玩家
断线 → battle-reconnected + 重放缓存
```

---

## 7. 任务清单（后端）
| 编号 | 任务 | 说明 |
| ---- | ---- | ---- |
| BE-01 | 抽离 ConfigService/Logger | 统一配置与日志 |
| BE-02 | Controllers 分层 | battle-server.js 仅保留引导 |
| BE-03 | Room/Battle 单元测试 | Jest + 模拟 BattleStream |
| BE-04 | AI 策略接口化 | 支持注入自定义策略/LLM |
| BE-05 | 资源 manifest 服务 | 为前端/脚本提供统一查询 |
| BE-06 | Diagnostics API | 暴露健康检查、连接数、房间数（已上线） |
| BE-07 | 性能指标 API | 处理 BattleEngine 上报、离线缓存、限流 |
| BE-08 | Prometheus + Health | /metrics、/health、/api/diagnostics 与报警联动 |

---

## 8. 参考
- `docs/架构说明文档.md`
- `docs/项目开发文档.md`
- `docs/architecture/重构路线图.md`

> 更新模块时请同步维护本文件及路线图。***


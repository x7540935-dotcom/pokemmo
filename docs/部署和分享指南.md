# 部署和分享指南

## 目录

- [本地部署](#本地部署)
- [分享给其他人](#分享给其他人)
- [服务器配置](#服务器配置)
- [常见问题](#常见问题)

---

## 本地部署

### 方式一：直接打开 HTML 文件（仅本地使用）

1. **启动对战服务器**：
   ```bash
   cd "pokemmo myself/poke-proxy-server"
   node battle-server.js
   ```

2. **打开网页**：
   - 直接用浏览器打开 `pokemmo.html` 或 `pvp-lobby.html`
   - 服务器地址会自动使用 `ws://localhost:3071/battle`

**限制**：只能在同一台电脑上使用，其他人无法连接。

### 方式二：使用内置 HTTP 服务器（推荐用于分享）

如果你使用 IDE（如 WebStorm、PyCharm）打开项目，看到类似 `http://localhost:63342/...` 的地址，这个地址只能本地访问。

**解决方案**：使用项目提供的简单 HTTP 服务器

1. **启动前端 HTTP 服务器**：
   
   **在 PyCharm 终端中**：
   ```bash
   # 确保在项目根目录
   cd "E:\XIANGMU\pokemmo\pokemmo myself"
   
   # 启动服务器
   node simple-http-server.js 8080
   ```
   
   **或使用批处理文件（Windows）**：
   ```bash
   启动前端服务器.bat
   ```
   
   **详细说明**：查看 [PyCharm 使用指南](./PyCharm使用指南.md)

2. **启动对战服务器**（另一个终端）：
   ```bash
   cd "pokemmo myself/poke-proxy-server"
   node battle-server.js
   ```

3. **获取你的 IP 地址**：
   ```bash
   # Windows
   ipconfig
   # 查找 IPv4 地址，如 192.168.1.100
   
   # Linux/Mac
   ifconfig
   # 或
   ip addr
   ```

4. **分享链接**：
   ```
   http://你的IP:8080/pvp-lobby.html?server=ws://你的IP:3071
   ```
   
   例如，如果你的 IP 是 `192.168.1.100`：
   ```
   http://192.168.1.100:8080/pvp-lobby.html?server=ws://192.168.1.100:3071
   ```

5. **其他人打开链接后**：
   - 前端文件从你的 HTTP 服务器加载
   - WebSocket 连接到你的对战服务器
   - 可以正常进行对战

---

## 分享给其他人

### 前提条件

要让其他人能够连接到你的服务器，需要：

1. **服务器有公网 IP 或域名**
2. **防火墙开放 3071 端口**
3. **服务器持续运行**

### 方式一：使用项目内置的 HTTP 服务器（最简单）

**适用场景**：快速分享给局域网内的其他人

**步骤**：

1. **启动前端 HTTP 服务器**：
   ```bash
   # Windows
   启动前端服务器.bat
   
   # Linux/Mac
   node simple-http-server.js 8080
   ```

2. **启动对战服务器**（另一个终端）：
   ```bash
   cd "pokemmo myself/poke-proxy-server"
   node battle-server.js
   ```

3. **获取你的 IP 地址**并分享链接：
   ```
   http://你的IP:8080/pvp-lobby.html?server=ws://你的IP:3071
   ```

**优点**：
- ✅ 无需配置复杂的 Web 服务器
- ✅ 一键启动，简单方便
- ✅ 适合局域网内分享

**限制**：
- ⚠️ 只能在同一网络内访问（除非配置端口转发）
  - 配置端口转发后，可以使用公网 IP 访问
  - 详细步骤请查看：[路由器端口转发配置指南](./路由器端口转发配置指南.md)
- ⚠️ 需要保持两个服务器都运行

### 方式二：通过 URL 参数指定服务器地址（适合已有 Web 服务器）

**步骤**：

1. **启动你的服务器**（确保服务器有公网访问）

2. **修改 HTML 文件中的链接**，添加 `server` 参数：
   ```html
   <!-- 原始链接 -->
   <a href="pvp-lobby.html">PvP 对战</a>
   
   <!-- 修改为（假设你的服务器地址是 ws://your-server.com:3071） -->
   <a href="pvp-lobby.html?server=ws://your-server.com:3071">PvP 对战</a>
   ```

3. **或者直接分享带参数的链接**：
   ```
   http://your-domain.com/pvp-lobby.html?server=ws://your-server.com:3071
   ```

4. **其他人打开链接后**，会自动连接到你的服务器

**示例**：
- 如果你的服务器在 `192.168.1.100:3071`：
  ```
  pvp-lobby.html?server=ws://192.168.1.100:3071
  ```
- 如果你的服务器有域名 `pokemmo.example.com`：
  ```
  pvp-lobby.html?server=ws://pokemmo.example.com:3071
  ```

### 方式二：通过 HTTP 服务器部署（推荐用于生产环境）

**步骤**：

1. **将整个项目部署到 Web 服务器**（Nginx、Apache 等）

2. **配置 Web 服务器**：
   ```nginx
   # Nginx 配置示例
   server {
       listen 80;
       server_name your-domain.com;
       
       root /path/to/pokemmo-myself;
       index pokemmo.html;
       
       location / {
           try_files $uri $uri/ =404;
       }
   }
   ```

3. **修改服务器地址配置**：
   - 如果 Web 服务器和 WebSocket 服务器在同一台机器，前端会自动使用当前域名
   - 如果不在同一台机器，使用方式一的 URL 参数方法

4. **分享链接**：
   ```
   http://your-domain.com/pvp-lobby.html
   ```

### 方式三：修改代码中的默认服务器地址

如果所有用户都连接到同一个服务器，可以直接修改代码：

**修改 `packages/battle-engine/src/core/BattleEngine.js`**：
```javascript
// 找到这一行（约第 20 行）
this.url = url || `ws://${location.hostname || 'localhost'}:3071/battle`;

// 修改为你的服务器地址
this.url = url || `ws://your-server.com:3071/battle`;
```

**注意**：这种方式需要修改代码，不推荐用于分享。

---

## 服务器配置

### 获取公网 IP

1. **查看本机 IP**：
   ```bash
   # Windows
   ipconfig
   
   # Linux/Mac
   ifconfig
   # 或
   ip addr
   ```

2. **如果是内网 IP**（如 192.168.x.x），需要：
   - 配置路由器端口转发（将 8080 和 3071 端口转发到你的电脑）
     - 详细步骤请查看：[路由器端口转发配置指南](./路由器端口转发配置指南.md)
   - 或使用内网穿透工具（如 ngrok、frp 等）

### 防火墙配置

**Windows**：
```powershell
# 允许 3071 端口入站
New-NetFirewallRule -DisplayName "Pokemmo Battle Server" -Direction Inbound -LocalPort 3071 -Protocol TCP -Action Allow
```

**Linux**：
```bash
# Ubuntu/Debian
sudo ufw allow 3071/tcp

# CentOS/RHEL
sudo firewall-cmd --add-port=3071/tcp --permanent
sudo firewall-cmd --reload
```

### 使用内网穿透（推荐用于测试）

**ngrok 示例**：
```bash
# 安装 ngrok
# 下载: https://ngrok.com/download

# 启动隧道
ngrok tcp 3071

# 会显示类似：
# Forwarding  tcp://0.tcp.ngrok.io:12345 -> localhost:3071
# 使用 ws://0.tcp.ngrok.io:12345 作为服务器地址
```

**注意**：免费版 ngrok 每次重启地址会变化。

---

## 监控与健康检查

部署后务必添加最少可观测性，便于排障与自动化运维。

| 检查项 | 端点 | 说明 |
| ---- | ---- | ---- |
| Liveness | `GET /health/live` | 检查 Node 进程是否仍在运行。建议用于 Kubernetes/PM2 健康探针。 |
| Readiness | `GET /health/ready` | 校验 Pokemon Showdown 适配器、WS 监听、房间/对战统计是否正常。 |
| 综合健康 | `GET /health` | 返回状态、服务依赖、日志/资源指标，UI 或 API 可直接读取。 |
| 诊断 | `GET /api/diagnostics` | 提供连接数、房间数、Battle 队列、内存、CPU、日志统计等详细数据。 |
| Prometheus | `GET /metrics` | 暴露 WebSocket、Battle、AI、进程指标（Counter/Gauge/Histogram）。 |
| 性能上报 | `GET /api/metrics` | 查询 BattleEngine 通过 Web Vitals & 自定义埋点上报的数据。 |

### 快速验证脚本
```bash
# 基础健康
curl http://your-server.com:3071/health
curl http://your-server.com:3071/health/ready

# Prometheus 指标
curl http://your-server.com:3071/metrics

# 前端性能指标（最新 50 条）
curl "http://your-server.com:3071/api/metrics?limit=50"

# 诊断数据
curl http://your-server.com:3071/api/diagnostics | jq
```

### 仪表板/报警建议
1. **接入 Prometheus + Grafana**：监控 WebSocket 连接数、AI Battle 构建耗时、错误率。
2. **接入 Alertmanager**：当 `/health` 返回 `degraded` 或 `unhealthy` 时提醒。
3. **室友/朋友部署**：至少每隔 30 秒 `curl /health/ready` 以确保可用。

---

## 常见问题

### Q1: 其他人无法连接到我的服务器

**检查清单**：
1. ✅ 服务器是否正在运行？
2. ✅ 服务器地址是否正确？
3. ✅ 防火墙是否开放 3071 端口？
4. ✅ 如果是内网 IP，是否配置了端口转发？
5. ✅ 浏览器控制台是否有错误信息？

**调试方法**：
- 在服务器端查看连接日志
- 在浏览器控制台查看 WebSocket 连接错误
- 使用 `telnet your-server.com 3071` 测试端口是否开放

### Q2: 通过 file:// 协议打开无法连接

**原因**：`file://` 协议下，`location.hostname` 为空，会回退到 `localhost`。

**解决方案**：
- 使用 URL 参数指定服务器地址：
  ```
  file:///path/to/pvp-lobby.html?server=ws://your-server.com:3071
  ```
- 或通过 HTTP 服务器访问（推荐）

### Q3: 连接被拒绝（Connection Refused）

**可能原因**：
1. 服务器未启动
2. 端口被占用
3. 防火墙阻止
4. 服务器地址错误

**解决方法**：
1. 检查服务器是否运行：`netstat -an | findstr 3071`（Windows）或 `netstat -an | grep 3071`（Linux）
2. 检查防火墙设置
3. 确认服务器地址和端口正确

### Q4: 跨域问题（CORS）

**如果通过 HTTP 服务器访问**，可能需要配置 CORS。

**后端不需要特殊配置**（WebSocket 不受 CORS 限制），但如果是 HTTP 请求，需要在服务器配置中添加 CORS 头。

### Q5: 如何让服务器在后台持续运行？

**Windows**：
```powershell
# 使用 PowerShell 后台运行
Start-Process node -ArgumentList "battle-server.js" -WindowStyle Hidden
```

**Linux/Mac**：
```bash
# 使用 nohup
nohup node battle-server.js > server.log 2>&1 &

# 或使用 PM2（推荐）
npm install -g pm2
pm2 start battle-server.js --name pokemmo-battle
pm2 save
pm2 startup
```

---

## 快速测试

### 测试服务器是否可访问

1. **在同一网络内测试**：
   - 获取服务器内网 IP（如 `192.168.1.100`）
   - 其他人使用：`pvp-lobby.html?server=ws://192.168.1.100:3071`

2. **测试连接**：
   ```javascript
   // 在浏览器控制台运行
   const ws = new WebSocket('ws://your-server.com:3071/battle');
   ws.onopen = () => console.log('连接成功！');
   ws.onerror = (e) => console.error('连接失败：', e);
   ```

---

## 安全建议

1. **生产环境使用 WSS**（WebSocket Secure）：
   - 配置 SSL 证书
   - 修改服务器使用 `wss://` 协议
   - 前端使用 `wss://your-server.com:3071/battle`

2. **添加身份验证**（可选）：
   - 在连接时验证用户身份
   - 限制连接数量
   - 防止恶意连接

3. **限制访问**（可选）：
   - 使用防火墙规则限制 IP
   - 添加访问令牌验证





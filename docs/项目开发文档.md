# Pokemmo Myself｜开发文档（重构版）

> 更新时间：2025-11-19  
> 适用范围：`pokemmo myself` 目录及其子项目  
> 文档目的：统一开发流程、梳理架构变化、指导后续重构工作

---

## 1. 背景与目标

### 1.1 项目简介
- 基于 **Pokemon Showdown** 的本地化对战平台
- 同时支持 **AI 对战** 与 **真人 PvP**
- 内置队伍管理、中文数据、RAG 增强 AI

### 1.2 重构目标
1. **结构清晰**：前端模块化、后端分层、工具职责单一
2. **易于扩展**：可插拔 AI、可配置资源、易于联机部署
3. **工程规范**：统一脚本、测试、CI 与文档

路线图详见 `docs/architecture/重构路线图.md`。

---

## 2. 架构总览（现状 vs 目标）

| 维度 | 现状 | 目标 |
| ---- | ---- | ---- |
| 前端结构 | 多 HTML + 全局脚本 | 多入口构建（Vite）+ 模块化 engine |
| 后端结构 | `battle-server.js` 职责过载 | 引导层 / 应用层 / 领域层 / 适配层 |
| 数据/资源 | 手工放置、缺少 manifest | 自动化流水线 + 校验脚本 |
| 脚本工具 | 分散、部分失效 | npm scripts 统一入口 |
| 文档 | 多版本混杂 | 单一信息源（本文件 + 模块文档 + ADR） |

### 2.1 目标蓝图
```
apps/
 ├─ pokemmo (AI 入口)
 └─ pvp-lobby (PvP / battle)
packages/
 └─ battle-engine (WebSocket + 状态机 + UI 基础)
services/
 └─ battle-server (WS + AI + PvP handlers)
```

---

## 3. 开发环境

| 组件 | 要求 | 说明 |
| ---- | ---- | ---- |
| Node.js | 18+ | 为 ws/代理/未来打包提供一致运行时 |
| npm/pnpm | 最新稳定 | 推荐 pnpm（待 Phase 2 切换） |
| 浏览器 | Chrome/Edge/Firefox | 需要支持 WebSocket / IndexedDB |
| 可选 | Python 3.8+ | RAG 脚本、数据分析 |

依赖安装：
```bash
npm install                     # 根脚本、静态服务
cd "pokemmo myself/poke-proxy-server" && npm install
# 如需自定义端口/路径，复制环境变量示例
# cp env.example .env
```

---

## 4. 工作流

### 4.1 启动与调试
```bash
# 启动后端 battle server
cd "pokemmo myself/poke-proxy-server"
node battle-server.js

# 启动静态前端（分享/多端调试）
cd "pokemmo myself"
node simple-http-server.js 8080
```

调试入口：
- `pokemmo.html`：AI + 队伍管理
- `pvp-lobby.html`：房间管理
- `battle.html`：共用对战 UI

### 4.2 目录（2025-11 版）
```
pokemmo myself/
├─ packages/
│  └─ battle-engine/   # 前端核心（ES Module，含 legacy shim）
├─ poke-proxy-server/  # WS + AI + PvP 后端
├─ docs/               # 文档（本文件/架构/模块）
├─ tools/              # 仍在使用的辅助脚本
├─ cache/, data/       # 资源与翻译
└─ *.html              # 传统入口（通过 shim 加载 battle-engine）
```

### 4.3 代码规范
- JS/TS：ESLint（已配置），使用推荐规则集
- 命名：`PascalCase`（类），`camelCase`（函数/变量），`SCREAMING_SNAKE_CASE`（常量）
- 日志：统一 `[模块名]` 前缀，敏感信息脱敏
- 文档：Markdown + 中文，必要时附图

### 4.4 测试与质量检查
```bash
# 代码检查
npm run lint              # ESLint 检查
npm run lint:fix          # 自动修复

# 单元测试（后端）
cd poke-proxy-server
npm test                  # Jest 单元测试
npm run test:coverage     # 生成覆盖率报告

# E2E 测试
npm run test:e2e          # Playwright E2E 测试
npm run test:e2e:ui       # 使用 UI 模式运行
npm run test:e2e:headed   # 有头模式运行（可见浏览器）

# 资源校验 & 观测
npm run manifest:all       # 生成资源清单
npm run validate:resources # 校验资源完整性
npm run check:bundle-size  # 检查构建产物体积
curl http://localhost:3071/health        # 健康检查
curl http://localhost:3071/api/diagnostics # 查看诊断详情
```

---

## 5. 架构与模块

### 5.1 前端（详见 `docs/modules/前端模块说明.md`）
- `packages/battle-engine/src/core`：BattleEngine / ProtocolParser / StateManager
- `packages/battle-engine/src/state-machine`：BattleStateMachine + PhaseBase
- `packages/battle-engine/src/phases`：TeamLoading / TeamPreview / PokemonData / Battle
- `packages/battle-engine/src/ui`：BattleUI
- `packages/battle-engine/src/utils`：Localization / SpriteLoader / PokemonUtils / Logger

重构要点：
1. 拆分 BattleEngine（连接、协议、日志）
2. 给 Phase 引入事件总线，消除全局依赖
3. 添加构建产物（ESM + IIFE）供旧页面使用

### 5.2 后端（详见 `docs/modules/后端模块说明.md`）
- `battle-server.js`：入口，已拆分为 `bootstrap + controllers`
- `server/bootstrap.js`：HTTP/WS 服务器引导
- `controllers/`：connectionController、AIBattleController、PvPController
- `domain/`：BattleManager、SimplePvPManager、RoomManager、ChoiceHandlers
- `adapters/`：Pokemon Showdown、资源加载、日志适配层
- `core/ai/`：Simple/Medium/Advanced/Expert AI + 工具
- `core/tools/`：TypeChartCalculator、DamageCalculator 等

重构要点：
1. ✅ controller/manager 分层，避免在入口里直接 new
2. ✅ 统一日志与错误码（Logger 适配层）
3. ✅ 引入配置（dotenv + schema 验证）
4. ✅ 编写 handler 单测 + BattleStream 集成测试

### 5.3 资源 & 数据
- 翻译：`data/chinese/*.json`
- Sprites：`cache/sprites/`（由代理或同步脚本生成）
- 缺失记录：`missing-sprites.json`
- Manifest：`cache/sprites-manifest.json`、`data/data-manifest.json`

资源管理工具：
- `tools/generate-sprites-manifest.mjs`：生成贴图清单
- `tools/generate-data-manifest.mjs`：生成数据清单
- `tools/validate-resources.mjs`：校验资源完整性
- `tools/check-bundle-size.mjs`：检查构建产物体积

所有工具已集成到 npm scripts，并在 CI 中自动运行。

---

## 6. CI/CD 与自动化

### 6.1 GitHub Actions
- 工作流文件：`.github/workflows/ci.yml`
- 包含步骤：
  1. Lint 检查
  2. 单元测试（前端 + 后端）
  3. 集成测试（WebSocket 冒烟）
  4. 资源校验（manifest 生成 + 校验）
  5. 体积阈值检查
  6. E2E 测试（Playwright）

### 6.2 本地开发流程
```bash
# 1. 代码检查
npm run lint

# 2. 运行测试
npm test                    # 前端测试
cd poke-proxy-server && npm test  # 后端测试
npm run test:e2e           # E2E 测试

# 3. 资源管理
npm run manifest:all       # 更新资源清单
npm run validate:resources # 校验资源
npm run check:bundle-size  # 体积监控

# 4. 观测/探针
curl http://localhost:3071/metrics          # Prometheus 指标
curl http://localhost:3071/api/metrics      # 前端性能数据
curl http://localhost:3071/health/ready     # 就绪探针
curl http://localhost:3071/api/diagnostics  # 诊断数据

# 5. 提交前检查
npm run lint && npm run validate:resources
```

---

## 7. 观测 & 运维

| 项目 | 位置 | 说明 |
| ---- | ---- | ---- |
| Prometheus 指标 | `GET /metrics` | 由 `adapters/metrics/*` 暴露，包含 WS 与 Battle 指标 |
| 前端性能 | `GET /api/metrics` / `POST /api/metrics` | BattleEngine Web Vitals & 自定义埋点 |
| 健康探针 | `/health`, `/health/live`, `/health/ready` | 供 k8s/负载均衡判断状态 |
| 诊断端点 | `/api/diagnostics` | 汇总连接、房间、Battle、日志、资源占用 |
| 日志聚合 | `adapters/logging/LogAggregator` | 通过健康/诊断端点暴露统计、最近日志数 |

> 推荐在生产环境配置 Prometheus/Grafana、Alertmanager；将 `/health/live` 用作 Liveness，`/health/ready` 用作 Readiness。

---

## 8. 部署指南

### 8.1 后端
```bash
cd "pokemmo myself/poke-proxy-server"
PORT=3071 node battle-server.js
# 推荐使用 PM2/forever 进行守护
```

### 8.2 前端
1. 直接部署静态文件（Nginx/Apache）
2. 配置 WebSocket 反向代理：`/battle` → `ws://<server>:3071/battle`
3. 若共享给公网用户，请更新 `?server=` 参数或在 HTML 内写死域名

### 8.3 RAG/AI 扩展
- RAG 目录不参与默认部署；仅在启用 Expert AI（难度 5）时需要
- 如需云端 LLM，请在 `.env` 中提供密钥并在文档/代码中注明

---

## 9. 常见问题（FAQ）

| 问题 | 排查步骤 |
| ---- | ---- |
| 前端无法连接 | 检查 `ws://localhost:3071/battle` 可达；确认浏览器 URL 带 server 参数 |
| 某些宝可梦无贴图 | 查看 `missing-sprites.json`，手动下载放入 `cache/sprites` |
| PvP 重连失败 | 确认 `battle-server` 控制台是否输出 `[PvPHandler] battle-reconnected`；若无，检查房间缓存 |
| AI 不行动 | 打开 `DEBUG_AI=1 node battle-server.js` 观察日志 |

---

## 10. 贡献流程

1. 认领 `docs/architecture/重构路线图.md` 中的任务或提交新 ADR
2. Fork / 创建分支，完成修改并附带测试说明
3. 在 PR 中附：
   - 变更内容 & 影响范围
   - 测试方式（截图 / 日志）
   - 是否涉及资源体积变化
4. 审阅通过后合并；如涉及架构，需更新对应文档

---

## 11. 附录

- 架构文档：`docs/架构说明文档.md`
- 模块文档：`docs/modules/前端模块说明.md`, `docs/modules/后端模块说明.md`
- 功能文档：`docs/features/真人对战功能开发文档.md`
- 测试指南：`docs/PvP双人对战测试指南.md`

如有疑问，请在 Issue/Discussions 中反馈。欢迎为重构贡献力量！
欢迎提交 Issue 和 Pull Request！

---

**最后更新**：2025-01-XX


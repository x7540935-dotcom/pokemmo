# 动画系统回合制改进说明

> 本文档说明了对动画系统进行的回合制改进，实现了先攻方→伤害→间隔→后攻方的动画流程。

---

## 1. 改进目标

### 1.1 问题描述
- **问题**：双方动画过于连续，没有清晰的回合分隔
- **需求**：实现回合制动画流程，先攻方动画 → 伤害日志 → 结算 → 间隔 → 后攻方动画

### 1.2 改进内容
1. ✅ 添加回合管理机制
2. ✅ 实现动画分组和顺序控制
3. ✅ 添加双方动画之间的间隔
4. ✅ 延迟伤害/回复更新，在动画播放后显示
5. ✅ 添加血条滑动动画效果
6. ✅ 完善去重机制

---

## 2. 核心改进

### 2.1 AnimationManager 改进

#### 新增功能

**1. 回合管理**
```javascript
// 新增属性
this.currentTurn = null;              // 当前回合数
this.currentTurnAnimations = [];      // 当前回合的动画队列
this.turnInterval = 800;              // 双方动画间隔（毫秒）
this.processedMoves = new Set();     // 已处理的 move 动画（去重）
this.lastMoveTime = new Map();        // 每个 side 的最后 move 时间
```

**2. 回合控制方法**
- `startTurn(turnNumber)` - 开始新回合
- `endTurn()` - 结束当前回合，处理回合内的所有动画
- `shouldAddTurnInterval(payload)` - 判断是否添加回合间隔

**3. 完善去重机制**
```javascript
shouldSkipAnimation(type, payload) {
  // 1. 检查队列中是否有重复
  // 2. 检查当前回合动画中是否有重复的 move
  // 3. 检查同一 side 的 move 是否在短时间内重复（200ms 内）
  // 4. 检查当前正在执行的动画
}
```

**4. 动画间隔控制**
- 在 `processQueue()` 中，如果下一个动画是另一个 side 的 move，自动添加 `turnInterval` 间隔

### 2.2 BattlePhase 改进

#### 新增功能

**1. 回合管理**
```javascript
// 新增属性
this.currentTurn = null;
this.turnMoveQueue = [];
this.turnDamageQueue = [];
this.isProcessingTurn = false;
this.pendingDamageUpdates = new Map(); // 待处理的伤害更新
```

**2. 回合协议处理**
```javascript
handleTurnProtocol(line) {
  // 结束上一回合的动画处理
  if (this.currentTurn !== null && this.currentTurn !== turn) {
    this.endTurnAnimations();
  }
  
  // 开始新回合
  this.currentTurn = turn;
  this.animationManager.startTurn(turn);
}
```

**3. 伤害更新延迟**
```javascript
handleDamageProtocol(line) {
  // 保存伤害信息，不立即更新
  this.pendingDamageUpdates.set(side, { condition, ident, timestamp });
  
  // 延迟 650ms 后更新（等待 move 动画播放完成）
  setTimeout(() => {
    this.processPendingDamage(side);
  }, 650);
}
```

**4. 回复更新延迟**
- `handleHealProtocol()` 也采用延迟更新，保持一致性

### 2.3 BattleUI 改进

#### 新增功能

**1. 血条滑动动画**
```javascript
updateHPBarElement(bar, percent) {
  // 添加 transition 样式
  bar.style.transition = 'width 0.6s ease-out, background 0.3s ease';
  
  // 更新宽度（触发动画）
  bar.style.width = `${value}%`;
  
  // 根据 HP 百分比设置渐变色
  if (value > 50) {
    bar.style.background = 'linear-gradient(90deg, #4caf50, #52c234)';
  } else if (value > 25) {
    bar.style.background = 'linear-gradient(90deg, #ff9800, #ff6f00)';
  } else {
    bar.style.background = 'linear-gradient(90deg, #f44336, #d32f2f)';
  }
  
  // 如果 HP 减少，添加震动效果
  if (value < currentWidth) {
    this.addHPShakeEffect(bar);
  }
}
```

**2. HP 震动效果**
```javascript
addHPShakeEffect(bar) {
  const parent = bar.parentElement;
  parent.classList.add('hp-shake');
  setTimeout(() => {
    parent.classList.remove('hp-shake');
  }, 500);
}
```

### 2.4 CSS 样式改进

**在 `battle.html` 中添加：**

```css
/* HP 条过渡动画 */
.pokemon-card__hp > div {
  transition: width 0.6s ease-out, background 0.3s ease;
}

/* HP 震动动画（受到伤害时） */
.hp-shake {
  animation: hpShake 0.5s ease-in-out;
}

@keyframes hpShake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
  20%, 40%, 60%, 80% { transform: translateX(2px); }
}
```

---

## 3. 动画流程

### 3.1 回合开始

```
|turn|1
  ↓
AnimationManager.startTurn(1)
  ↓
BattlePhase.currentTurn = 1
  ↓
清空回合动画队列
```

### 3.2 先攻方动画

```
|move|p1a: Pokemon|moveName|p2a: Target
  ↓
AnimationManager.play('move', { side: 'p1', targetSide: 'p2', ... })
  ↓
动画播放（620ms）
  ↓
延迟 650ms 后更新 HP
```

### 3.3 伤害日志显示

```
|-damage|p2a: Target|100/100 → 50/100
  ↓
保存到 pendingDamageUpdates
  ↓
等待 650ms（动画播放完成）
  ↓
更新 HP 条（带滑动动画）
  ↓
显示伤害日志
```

### 3.4 间隔

```
先攻方动画完成
  ↓
检查下一个动画是否是后攻方的 move
  ↓
如果是，添加 turnInterval（800ms）间隔
  ↓
等待间隔结束
```

### 3.5 后攻方动画

```
|move|p2a: Pokemon|moveName|p1a: Target
  ↓
AnimationManager.play('move', { side: 'p2', targetSide: 'p1', ... })
  ↓
动画播放（620ms）
  ↓
延迟 650ms 后更新 HP
```

### 3.6 回合结束

```
|turn|2
  ↓
结束回合 1 的动画处理
  ↓
AnimationManager.endTurn()
  ↓
开始回合 2
```

---

## 4. 去重机制完善

### 4.1 多层去重检查

**1. 队列去重**
- 检查队列中是否有相同类型的动画（非 move 类型）

**2. 回合内去重**
- 检查当前回合动画中是否有重复的 move
- 使用 `processedMoves` Set 记录已处理的 move

**3. 时间窗口去重**
- 检查同一 side 的 move 是否在 200ms 内重复

**4. 当前执行去重**
- 检查当前正在执行的动画是否与要添加的相同

### 4.2 去重键生成

```javascript
// move 动画去重键
const moveKey = `${side}-${moveName}-${targetSide}`;

// 其他动画去重键
const duplicateKey = `${type}-${side}`;
```

---

## 5. 配置参数

### 5.1 可配置项

```javascript
// AnimationManager 构造函数
const animationManager = new AnimationManager({
  sprites: { p1: p1Sprite, p2: p2Sprite },
  layers: { p1: p1Layer, p2: p2Layer },
  turnInterval: 800,  // 双方动画间隔（毫秒）
  fxBasePath: './fx/'  // 特效资源路径
});
```

### 5.2 时间参数

| 参数 | 值 | 说明 |
| ---- | --- | ---- |
| `turnInterval` | 800ms | 双方动画之间的间隔 |
| `moveAnimationDuration` | 620ms | move 动画持续时间 |
| `statusAnimationDuration` | 700ms | 状态技能动画持续时间 |
| `damageUpdateDelay` | 650ms | 伤害更新延迟（等待动画完成） |
| `hpTransitionDuration` | 600ms | HP 条滑动动画持续时间 |
| `hpShakeDuration` | 500ms | HP 震动动画持续时间 |

---

## 6. 测试建议

### 6.1 功能测试

1. **回合分隔测试**
   - [ ] 验证回合开始时是否正确初始化
   - [ ] 验证回合结束时是否正确处理动画队列
   - [ ] 验证双方动画之间是否有间隔

2. **动画顺序测试**
   - [ ] 验证先攻方动画是否先播放
   - [ ] 验证伤害更新是否在动画后显示
   - [ ] 验证后攻方动画是否在间隔后播放

3. **去重测试**
   - [ ] 验证重复协议是否被正确跳过
   - [ ] 验证短时间内重复 move 是否被过滤
   - [ ] 验证不同 side 的 move 是否可以同时播放

4. **HP 动画测试**
   - [ ] 验证 HP 条是否有滑动动画
   - [ ] 验证受到伤害时是否有震动效果
   - [ ] 验证 HP 颜色是否根据百分比变化

### 6.2 性能测试

- [ ] 验证大量动画队列时是否流畅
- [ ] 验证动画间隔是否影响用户体验
- [ ] 验证去重机制是否有效减少不必要的动画

---

## 7. 已知问题与限制

### 7.1 已知问题

1. **伤害更新时机**
   - 当前使用固定延迟（650ms），可能与实际动画时长不完全匹配
   - 建议：根据实际动画时长动态调整延迟

2. **回合结束时机**
   - 当前在收到新的 `|turn|` 协议时结束上一回合
   - 如果回合内没有 move 动画，可能不会触发 `endTurn()`

### 7.2 改进建议

1. **动态延迟计算**
   ```javascript
   // 根据实际动画时长计算延迟
   const animationDuration = this.getAnimationDuration(type);
   setTimeout(() => {
     this.processPendingDamage(side);
   }, animationDuration + 30); // 动画时长 + 30ms 缓冲
   ```

2. **回合超时处理**
   ```javascript
   // 如果回合内没有动画，设置超时自动结束
   this.turnTimeout = setTimeout(() => {
     this.endTurnAnimations();
   }, 5000); // 5秒超时
   ```

---

## 8. 使用示例

### 8.1 基本使用

```javascript
// 初始化
const animationManager = new AnimationManager({
  sprites: { p1: p1Sprite, p2: p2Sprite },
  layers: { p1: p1Layer, p2: p2Layer },
  turnInterval: 800
});

// 在 BattlePhase 中使用
const battlePhase = new BattlePhase(battleEngine, stateManager, ui, animationManager);

// 回合开始时
battlePhase.handleTurnProtocol('|turn|1');
// AnimationManager 会自动调用 startTurn(1)

// 技能动画
battlePhase.handleMoveAnimation('|move|p1a: Pokemon|moveName|p2a: Target');
// 动画播放，650ms 后更新 HP

// 伤害协议
battlePhase.handleDamageProtocol('|-damage|p2a: Target|100/100 → 50/100');
// 延迟更新 HP，显示伤害日志
```

---

**文档版本**：1.0.0  
**更新日期**：2025-01-20  
**相关文件**：
- `packages/battle-engine/src/animations/AnimationManager.js`
- `packages/battle-engine/src/phases/BattlePhase.js`
- `packages/battle-engine/src/ui/BattleUI.js`
- `battle.html`

